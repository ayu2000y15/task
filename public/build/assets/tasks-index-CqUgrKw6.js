import{a as h}from"./app-B2MAfdmL.js";function q(e){switch(e){case"completed":return'<i class="fas fa-check-circle text-green-500" title="完了"></i>';case"in_progress":return'<i class="fas fa-play-circle text-blue-500" title="進行中"></i>';case"on_hold":return'<i class="fas fa-pause-circle text-yellow-500" title="一時停止中"></i>';case"cancelled":return'<i class="fas fa-times-circle text-red-500" title="キャンセル"></i>';case"not_started":default:return'<i class="far fa-circle text-gray-400" title="未着手"></i>'}}function y(e,s,i){if(!e)return;const c=e.querySelector(".task-status-icon-wrapper");if(c){let a=!1;if(e.tagName.toLowerCase()==="tr"){const r=e.querySelector("td:nth-child(2), td:nth-child(1)");r&&(a=!!(r.querySelector("i.fa-flag")||r.querySelector("i.fa-folder")))}else e.tagName.toLowerCase()==="li"&&(a=!!(c.querySelector("i.fa-flag")||c.querySelector("i.fa-folder")));a||(c.innerHTML=q(s))}e.dataset.progress=i;const t=e.querySelector(".task-status-select");t&&(t.value=s)}function E(){document.querySelectorAll(".task-status-checkbox").forEach(e=>{e.addEventListener("change",function(){const s=this.closest("tr, li");if(!s)return;const i=s.dataset.taskId,c=s.dataset.projectId,t=this.dataset.action;if(!i||!c)return;const a=s.querySelector(".task-status-in-progress"),r=s.querySelector(".task-status-completed");let o="not_started",l=0,d=parseInt(s.dataset.progress||"0")||0;this.checked&&(t==="set-in-progress"&&r&&(r.checked=!1),t==="set-completed"&&a&&(a.checked=!1)),a!=null&&a.checked?(o="in_progress",l=d>0&&d<100?d:10):r!=null&&r.checked&&(o="completed",l=100),h.post(`/projects/${c}/tasks/${i}/progress`,{status:o,progress:l}).then(n=>{n.data.success&&y(s,o,l)})})})}function v(){document.querySelectorAll(".task-status-select").forEach(e=>{e.addEventListener("change",function(){var r;const s=this.dataset.taskId,i=this.dataset.projectId,c=this.value;let t=0,a=parseInt(((r=this.closest("tr, li"))==null?void 0:r.dataset.progress)||"0")||0;c==="completed"?t=100:c==="in_progress"&&(t=a>0&&a<100?a:10),h.post(`/projects/${i}/tasks/${s}/progress`,{status:c,progress:t}).then(o=>{if(o.data.success){const l=this.closest("tr, li");y(l,c,t)}})})})}function w(){const e=document.querySelectorAll('[id^="assignee-data-container"]');if(e.length===0){console.warn("担当者選択肢のデータコンテナが見つかりません。");return}e.forEach(s=>{let i=[];try{i=JSON.parse(s.dataset.assigneeOptions)}catch(t){console.error("担当者選択肢のJSON解析に失敗しました。",t,s);return}s.querySelectorAll(".editable-cell-assignees").forEach(t=>{t.addEventListener("click",function(a){if(t.querySelector(".ts-control"))return;const r=t.closest("tr");if(!r)return;const o=r.dataset.taskId,l=r.dataset.projectId,d=JSON.parse(t.dataset.currentAssignees||"[]"),n=t.querySelector(".assignee-badge-container");n&&(n.style.display="none");const f=document.createElement("select");f.setAttribute("multiple","multiple"),t.appendChild(f);const m=new TomSelect(f,{options:i,items:d,valueField:"id",labelField:"name",searchField:"name",plugins:["remove_button"],create:!1,placeholder:"担当者を選択...",onBlur:function(){setTimeout(()=>{k(this)},150)}}),k=u=>{if(!u.wrapper)return;const g=u.items,S=[...d].sort(),I=[...g].sort();if(JSON.stringify(S)===JSON.stringify(I)){n&&(n.style.display="flex"),u.destroy(),f.remove();return}h.post(`/projects/${l}/tasks/${o}/assignee`,{assignees:g}).then(p=>{p.data.success?(n&&(n.innerHTML=p.data.assigneesHtml,n.style.display="flex"),t.dataset.currentAssignees=JSON.stringify(g)):(n&&(n.style.display="flex"),alert(p.data.message||"更新に失敗しました。"))}).catch(p=>{console.error("担当者の更新中にエラーが発生しました:",p),alert("担当者の更新中にエラーが発生しました。"),n&&(n.style.display="flex")}).finally(()=>{u.wrapper&&u.destroy(),f.parentNode&&f.remove()})};m.focus()})})})}function x(){document.querySelectorAll(".toggle-folder-files").forEach(e=>{e.addEventListener("click",function(){const s=document.getElementById(this.dataset.target),i=this.querySelector("i");!s||!i||(s.classList.toggle("hidden"),i.classList.toggle("fa-chevron-down"),i.classList.toggle("fa-chevron-up"))})})}try{v(),E(),w(),x()}catch(e){console.error("Error during tasks-index.js specific initialization:",e)}
