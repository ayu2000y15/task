import{a as h}from"./app-CZ1ugLGW.js";function I(s){switch(s){case"completed":return'<i class="fas fa-check-circle text-green-500" title="完了"></i>';case"in_progress":return'<i class="fas fa-play-circle text-blue-500" title="進行中"></i>';case"on_hold":return'<i class="fas fa-pause-circle text-yellow-500" title="保留中"></i>';case"cancelled":return'<i class="fas fa-times-circle text-red-500" title="キャンセル"></i>';case"not_started":default:return'<i class="far fa-circle text-gray-400" title="未着手"></i>'}}function k(s,t,r){if(!s)return;const i=s.querySelector(".task-status-icon-wrapper");if(i){let c=!1;if(s.tagName.toLowerCase()==="tr"){const a=s.querySelector("td:nth-child(2)");a&&(c=!!(a.querySelector("i.fa-flag")||a.querySelector("i.fa-folder")))}else s.tagName.toLowerCase()==="li"&&(c=!!(i.querySelector("i.fa-flag")||i.querySelector("i.fa-folder")));c||(i.innerHTML=I(t))}s.dataset.progress=r;const e=s.querySelector(".task-status-select");e&&(e.value=t,e.dataset.originalStatus=t,e.dataset.currentProgress=r)}function E(){document.querySelectorAll(".task-status-checkbox").forEach(s=>{s.addEventListener("change",function(){const t=this.closest("tr, li");if(!t)return;const r=t.dataset.taskId,i=t.dataset.projectId,e=this.dataset.action;if(!r||!i)return;const c=t.querySelector(".task-status-in-progress"),a=t.querySelector(".task-status-completed");let d="not_started",n=0,l=parseInt(t.dataset.progress||"0")||0;this.checked&&(e==="set-in-progress"&&a&&(a.checked=!1),e==="set-completed"&&c&&(c.checked=!1)),c!=null&&c.checked?(d="in_progress",n=l>0&&l<100?l:10):a!=null&&a.checked&&(d="completed",n=100),h.post(`/projects/${i}/tasks/${r}/progress`,{status:d,progress:n}).then(o=>{o.data.success&&k(t,d,n)})})})}function x(){document.querySelectorAll(".task-status-select").forEach(s=>{s.addEventListener("change",function(){var a;const t=this.dataset.taskId,r=this.dataset.projectId,i=this.value;let e=0,c=parseInt(((a=this.closest("tr, li"))==null?void 0:a.dataset.progress)||"0")||0;i==="completed"?e=100:i==="in_progress"&&(e=c>0&&c<100?c:10),h.post(`/projects/${r}/tasks/${t}/progress`,{status:i,progress:e}).then(d=>{if(d.data.success){const n=this.closest("tr, li");k(n,i,e);const l=n==null?void 0:n.querySelector(".task-status-in-progress"),o=n==null?void 0:n.querySelector(".task-status-completed");l&&(l.checked=i==="in_progress"),o&&(o.checked=i==="completed")}})})})}function v(){const s=document.querySelectorAll('[id^="assignee-data-container"]');if(s.length===0){console.warn("担当者選択肢のデータコンテナが見つかりません。");return}s.forEach(t=>{let r=[];try{r=JSON.parse(t.dataset.assigneeOptions)}catch(e){console.error("担当者選択肢のJSON解析に失敗しました。",e,t);return}t.querySelectorAll(".editable-cell-assignees").forEach(e=>{e.addEventListener("click",function(c){if(e.querySelector(".ts-control"))return;const a=e.closest("tr");if(!a)return;const d=a.dataset.taskId,n=a.dataset.projectId,l=JSON.parse(e.dataset.currentAssignees||"[]"),o=e.querySelector(".assignee-badge-container");o&&(o.style.display="none");const u=document.createElement("select");u.setAttribute("multiple","multiple"),e.appendChild(u);const y=new TomSelect(u,{options:r,items:l,valueField:"id",labelField:"name",searchField:"name",plugins:["remove_button"],create:!1,placeholder:"担当者を選択...",onBlur:function(){setTimeout(()=>{m(this)},150)}}),m=f=>{if(!f.wrapper)return;const g=f.items,S=[...l].sort(),q=[...g].sort();if(JSON.stringify(S)===JSON.stringify(q)){o&&(o.style.display="flex"),f.destroy(),u.remove();return}h.post(`/projects/${n}/tasks/${d}/assignee`,{assignees:g}).then(p=>{p.data.success?(o&&(o.innerHTML=p.data.assigneesHtml,o.style.display="flex"),e.dataset.currentAssignees=JSON.stringify(g)):(o&&(o.style.display="flex"),alert(p.data.message||"更新に失敗しました。"))}).catch(p=>{console.error("担当者の更新中にエラーが発生しました:",p),alert("担当者の更新中にエラーが発生しました。"),o&&(o.style.display="flex")}).finally(()=>{f.wrapper&&f.destroy(),u.parentNode&&u.remove()})};y.focus()})})})}function b(){document.querySelectorAll(".toggle-folder-files").forEach(s=>{s.addEventListener("click",function(){const t=document.getElementById(this.dataset.target),r=this.querySelector("i");!t||!r||(t.classList.toggle("hidden"),r.classList.toggle("fa-chevron-down"),r.classList.toggle("fa-chevron-up"))})})}function w(){window.addEventListener("task-status-updated",s=>{const{taskId:t,newStatus:r,newProgress:i}=s.detail;if(!t||!r)return;const e=document.querySelector(`tr[data-task-id="${t}"], li[data-task-id="${t}"]`);if(e){k(e,r,i);const c=e.querySelector(".task-status-in-progress"),a=e.querySelector(".task-status-completed");c&&(c.checked=r==="in_progress"),a&&(a.checked=r==="completed")}})}try{x(),E(),v(),b(),w()}catch(s){console.error("Error during tasks-index.js specific initialization:",s)}
