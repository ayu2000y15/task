import{a as _}from"./app-CZ1ugLGW.js";const j={0:{tooltip:"未納品",icon:"fa-truck",colorClass:"text-yellow-500 dark:text-yellow-400"},1:{tooltip:"納品済み",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"}},R={Pending:{tooltip:"未払い",icon:"fa-clock",colorClass:"text-yellow-500 dark:text-yellow-400"},Processing:{tooltip:"支払い中",icon:"fa-hourglass-half",colorClass:"text-blue-500 dark:text-blue-400"},Completed:{tooltip:"支払完了",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"},"Partially Paid":{tooltip:"一部支払い",icon:"fa-adjust",colorClass:"text-orange-500 dark:text-orange-400"},Overdue:{tooltip:"期限切れ",icon:"fa-exclamation-triangle",colorClass:"text-red-500 dark:text-red-400"},Cancelled:{tooltip:"キャンセル",icon:"fa-ban",colorClass:"text-gray-500 dark:text-gray-400"},Refunded:{tooltip:"返金済み",icon:"fa-undo",colorClass:"text-purple-500 dark:text-purple-400"},"On Hold":{tooltip:"保留中",icon:"fa-pause-circle",colorClass:"text-indigo-500 dark:text-indigo-400"},"":{tooltip:"未設定",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"}},N={not_started:{tooltip:"未着手",icon:"fa-minus-circle",colorClass:"text-gray-500 dark:text-gray-400"},in_progress:{tooltip:"進行中",icon:"fa-play-circle",colorClass:"text-blue-500 dark:text-blue-400"},completed:{tooltip:"完了",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"},on_hold:{tooltip:"保留中",icon:"fa-pause-circle",colorClass:"text-yellow-500 dark:text-yellow-400"},cancelled:{tooltip:"キャンセル",icon:"fa-times-circle",colorClass:"text-red-500 dark:text-red-400"},"":{tooltip:"未設定",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"}};function O(n,e,a){if(n){const s=Object.keys(a).includes("")?"":Object.keys(a)[0],t=a[e]||a[s]||{tooltip:e||"-",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"};n.title=t.tooltip;const o=n.querySelector("i");if(o){const d=Array.from(o.classList).filter(r=>r.startsWith("fa-")||r.startsWith("text-")||r.startsWith("dark:text-"));o.classList.remove(...d);const i=t.icon.split(" ");o.classList.add("fas",...i),t.colorClass&&t.colorClass.split(" ").forEach(r=>o.classList.add(r))}else n.innerHTML=`<i class="fas ${t.icon} ${t.colorClass||""}"></i>`}}function U(n,e){n.dataset.projectId;const a=n.name,s=n.value,t=n.dataset.url,o=n.dataset.iconTarget,d=document.getElementById(o);_.patch(t,{[a]:s},{headers:{"X-CSRF-TOKEN":e,Accept:"application/json","Content-Type":"application/json"}}).then(i=>{if(i.data.success){if(d){let r;a==="delivery_flag"?r=j:a==="payment_flag"?r=R:a==="status"&&(r=N),r&&O(d,s,r)}if(i.data.updated_project_status!==void 0){const r=n.dataset.statusTargetSelect,u=n.dataset.statusTargetIcon;if(r){const l=document.getElementById(r);l&&(l.value=i.data.updated_project_status)}if(u){const l=document.getElementById(u);l&&O(l,i.data.updated_project_status,N)}}}else alert("更新に失敗しました: "+(i.data.message||"サーバーエラー"))}).catch(i=>{let r="更新中にエラーが発生しました。";i.response&&i.response.data&&i.response.data.message?r+=`
`+i.response.data.message:i.response&&i.response.status&&(r+=` (ステータス: ${i.response.status})`),alert(r)})}function x(n,e="処理に失敗しました。",a=null){let s=e,t=null;if(n&&n.data){if(n.data.message&&(typeof n.data.message!="object"||Object.keys(n.data.message).length>0)&&(s=n.data.message),n.data.errors){t=n.data.errors;let d=[];for(const i in t)d.push(t[i].join("; "));d.length>0&&s===e&&(s=d.join(`
`))}}else n&&typeof n=="string"&&(s=n);const o=a?document.getElementById(a):null;if(o&&t){let d='<ul class="list-disc pl-5 text-red-600 dark:text-red-400">';for(const r in t)t[r].forEach(u=>{d+=`<li>${b(u)}</li>`});d+="</ul>",o.innerHTML=d;const i=o.closest("form");i&&Object.keys(t).forEach(r=>{const u=r.includes(".")?r.split(".").map((c,p)=>p===0?c:`[${c}]`).join(""):r,l=i.querySelector(`[name="${u}"], [name="${u}[]"]`);l&&l.classList.add("border-red-500","dark:border-red-600")})}else o&&s?o.innerHTML=`<p class="text-red-600 dark:text-red-400">${S(b(String(s)))}</p>`:s&&!o&&alert(String(s))}function B(){const n=document.querySelector('meta[name="csrf-token"]');return n?n.getAttribute("content"):null}function b(n){return n===null||typeof n>"u"?"":String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function S(n){return typeof n>"u"||n===null?"":String(n).replace(/(\r\n|\n\r|\r|\n)/g,"<br>$1")}function E(n,e){const a=document.getElementById(`costs-content-${e}`);if(!a){console.warn(`Could not find costs tab container for character: ${e}`);return}const s=`/projects/${n}/characters/${e}/costs-partial`;_.get(s).then(t=>{a.innerHTML=t.data}).catch(t=>{console.error("Error refreshing costs list:",t),a.innerHTML='<p class="text-red-500 p-4">コスト情報の更新に失敗しました。</p>'})}function I(n,e){const a=document.getElementById(`measurement-form-${n}`);if(!a){console.warn(`Measurement form not found for reset: measurement-form-${n}`);return}a.reset(),a.setAttribute("action",e);const s=document.getElementById(`measurement-form-method-${n}`);s&&(s.value="POST");const t=document.getElementById(`measurement-form-id-${n}`);t&&(t.value="");const o=document.getElementById(`measurement-form-title-${n}`);o&&(o.textContent="採寸データを追加");const d=document.getElementById(`measurement-form-submit-btn-text-${n}`);d&&(d.textContent="追加");const i=document.getElementById(`measurement-form-submit-btn-${n}`);i&&(i.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),i.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"));const r=document.getElementById(`measurement-form-cancel-btn-${n}`);r&&(r.style.display="none");const u=document.getElementById(`measurement-form-errors-${n}`);u&&(u.innerHTML=""),a.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(l=>{l.classList.remove("border-red-500","dark:border-red-600")})}function D(n,e,a,s){const t=document.querySelector(`#measurements-content-${n} table tbody`);if(!t){console.warn(`Measurement table body not found for character ${n}`);return}const o=document.getElementById(`measurement-row-${e.id}`),d=e.notes?S(b(e.notes)):"-",i=B();let r='<div class="flex items-center justify-end space-x-1">';r+=`
        <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-measurement-btn"
                title="編集"
                data-id="${e.id}"
                data-item="${b(e.item||"")}"
                data-value="${b(e.value||"")}"
                data-notes="${b(e.notes||"")}">
            <i class="fas fa-edit fa-sm"></i>
        </button>`,r+=`
        <form action="/projects/${s.id}/characters/${n}/measurements/${e.id}"
              method="POST" class="delete-measurement-form"
              data-id="${e.id}"
              onsubmit="return false;">
            <input type="hidden" name="_token" value="${i}">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit"
                class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                title="削除">
                <i class="fas fa-trash fa-sm"></i>
            </button>
        </form>`,r+="</div>";const u=`
        <td class="px-2 py-1.5 whitespace-nowrap text-center text-gray-400 drag-handle">
            <i class="fas fa-grip-vertical"></i>
        </td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 measurement-item">${b(e.item)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 measurement-value">${b(e.value)}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 whitespace-pre-wrap break-words text-left leading-tight measurement-notes" style="min-width: 150px;">
            ${d}
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">
            ${r}
        </td>
    `;if(a&&o)o.innerHTML=u;else if(!a){const l=document.createElement("tr");l.id=`measurement-row-${e.id}`,l.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),l.innerHTML=u;const c=t.querySelector('td[colspan="4"]');c&&c.parentElement.remove(),t.appendChild(l)}}function W(n,e,a,s){const t=document.getElementById(`measurement-form-${e}`);if(!t){console.warn(`Measurement form not found for character ${e}`);return}const o=t.dataset.storeUrl,d=document.getElementById(`measurement-form-title-${e}`),i=document.getElementById(`measurement-form-submit-btn-${e}`),r=document.getElementById(`measurement-form-submit-btn-text-${e}`),u=document.getElementById(`measurement-form-cancel-btn-${e}`),l=document.getElementById(`measurement-form-method-${e}`),c=document.getElementById(`measurement-form-id-${e}`),p=`measurement-form-errors-${e}`;n.addEventListener("click",function(m){const f=m.target.closest(".edit-measurement-btn");if(f){m.preventDefault(),d&&(d.textContent="採寸データを編集"),t.setAttribute("action",`/projects/${s.id}/characters/${e}/measurements/${f.dataset.id}`),l&&(l.value="PUT"),c&&(c.value=f.dataset.id);const g=t.querySelector(`[id="measurement_item_input-${e}"]`),h=t.querySelector(`[id="measurement_value_input-${e}"]`),y=t.querySelector(`[id="measurement_notes_input-${e}"]`);g&&(g.value=f.dataset.item),h&&(h.value=f.dataset.value),y&&(y.value=f.dataset.notes||""),r&&(r.textContent="更新"),i&&(i.classList.remove("bg-green-500","hover:bg-green-600"),i.classList.add("bg-yellow-500","hover:bg-yellow-600")),u&&(u.style.display="inline-flex");const $=document.getElementById(p);$&&($.innerHTML=""),g&&g.focus()}const v=m.target.closest(".delete-measurement-form");v&&(m.preventDefault(),confirm("この採寸データを本当に削除しますか？")&&_.delete(v.action,{headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(g=>{if(g.data.success){const h=`measurement-row-${v.dataset.id}`,y=document.getElementById(h);y&&y.remove(),I(e,o)}else x(g,"削除に失敗しました。",p)}).catch(g=>{x(g.response,"削除中にエラーが発生しました。",p)}))}),u&&u.addEventListener("click",function(){I(e,o)}),t.addEventListener("submit",function(m){m.preventDefault();const f=document.getElementById(p);f&&(f.innerHTML="");const v=new FormData(t),g=t.getAttribute("action");let h="post";document.getElementById(`measurement-form-method-${e}`).value==="PUT"&&v.append("_method","PUT"),_({method:h,url:g,data:v,headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(y=>{if(y.data.success&&y.data.measurement){const $=document.getElementById(`measurement-form-method-${e}`).value==="PUT";D(e,y.data.measurement,$,s),I(e,o)}else x(y,"処理に失敗しました。",p)}).catch(y=>{x(y.response,"送信中にエラーが発生しました。",p)})})}function T(n){const e=document.getElementById(`material-form-${n}`);return e?{form:e,inventorySelect:document.getElementById(`inventory_item_id_input-${n}`),manualNameField:document.getElementById(`manual_material_name_field-${n}`),manualNameInput:document.getElementById(`manual_material_name_input-${n}`),unitDisplay:document.getElementById(`material_unit_display-${n}`),quantityInput:document.getElementById(`material_quantity_input-${n}`),priceDisplay:document.getElementById(`material_price_display-${n}`),notesInput:document.getElementById(`material_notes_input-${n}`),statusCheckbox:document.getElementById(`material_status_checkbox_for_form-${n}`),methodField:document.getElementById(`material-form-method-${n}`),idField:document.getElementById(`material-form-id-${n}`),nameHiddenInput:document.getElementById(`material_name_hidden_input-${n}`),unitHiddenInput:document.getElementById(`material_unit_hidden_input-${n}`),priceHiddenInput:document.getElementById(`material_price_hidden_input-${n}`),unitPriceHiddenInput:document.getElementById(`material_unit_price_hidden_input-${n}`),statusHiddenInput:document.getElementById(`material_status_hidden_input-${n}`),formTitle:document.getElementById(`material-form-title-${n}`),submitBtn:document.getElementById(`material-form-submit-btn-${n}`),submitBtnText:document.getElementById(`material-form-submit-btn-text-${n}`),cancelBtn:document.getElementById(`material-form-cancel-btn-${n}`),errorDiv:document.getElementById(`material-form-errors-${n}`),storeUrl:e.dataset.storeUrl,applyToOthersCheckbox:document.getElementById(`apply_material_to_other_characters-${n}`),applyToOthersWrapperForAdd:document.getElementById(`apply_to_others_wrapper_for_add_material-${n}`)}:null}function w(n){const e=T(n);if(!e||!e.quantityInput||!e.priceDisplay||!e.priceHiddenInput||!e.unitPriceHiddenInput)return;const a=e.inventorySelect.options[e.inventorySelect.selectedIndex],s=parseFloat(e.quantityInput.value);if(a.value&&a.value!=="manual_input"){const t=parseFloat(a.dataset.avg_price);if(!isNaN(t)&&!isNaN(s)&&s>0){const o=t*s;e.priceDisplay.value=Math.round(o).toLocaleString()+"円",e.priceHiddenInput.value=Math.round(o),e.unitPriceHiddenInput.value=t}else e.priceDisplay.value="",e.priceHiddenInput.value="",e.unitPriceHiddenInput.value=""}else if(a.value==="manual_input"){const t=e.priceDisplay.value.replace(/[円,]/g,""),o=parseFloat(t);isNaN(o)?(e.priceHiddenInput.value="",e.unitPriceHiddenInput.value=""):(e.priceHiddenInput.value=o,!isNaN(s)&&s>0?e.unitPriceHiddenInput.value=o/s:e.unitPriceHiddenInput.value="")}else e.priceDisplay.value="",e.priceHiddenInput.value="",e.unitPriceHiddenInput.value=""}function F(n){const e=T(n);if(!e)return;const a=e.inventorySelect.value,s=e.inventorySelect.options[e.inventorySelect.selectedIndex];a==="manual_input"?(e.manualNameField.classList.remove("hidden"),e.manualNameInput.required=!0,e.unitDisplay.readOnly=!1,e.unitDisplay.placeholder="単位を入力 (例: 個, m)",e.unitDisplay.classList.remove("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.priceDisplay.readOnly=!1,e.priceDisplay.placeholder="合計価格を入力 (例: 1000)",e.priceDisplay.classList.remove("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.statusCheckbox.checked=!1,e.statusCheckbox.disabled=!1,e.statusHiddenInput.value="未購入"):a?(e.manualNameField.classList.add("hidden"),e.manualNameInput.required=!1,e.manualNameInput.value="",e.unitDisplay.readOnly=!0,e.unitDisplay.placeholder="品目選択で自動表示",e.unitDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.unitDisplay.value=s.dataset.unit||"",e.priceDisplay.readOnly=!0,e.priceDisplay.placeholder="自動計算",e.priceDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.statusCheckbox.checked=!0,e.statusCheckbox.disabled=!0,e.statusHiddenInput.value="購入済",e.nameHiddenInput.value=s.dataset.name||"",e.unitHiddenInput.value=s.dataset.unit||""):(e.manualNameField.classList.add("hidden"),e.manualNameInput.required=!1,e.manualNameInput.value="",e.unitDisplay.readOnly=!0,e.unitDisplay.placeholder="品目選択で自動表示",e.unitDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.unitDisplay.value="",e.priceDisplay.readOnly=!0,e.priceDisplay.placeholder="自動計算",e.priceDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.priceDisplay.value="",e.statusCheckbox.checked=!1,e.statusCheckbox.disabled=!1,e.statusHiddenInput.value="未購入",e.nameHiddenInput.value="",e.unitHiddenInput.value=""),w(n)}function C(n,e){const a=T(n);if(!a)return;const s=e||a.storeUrl;a.form.reset(),a.form.setAttribute("action",s),a.methodField&&(a.methodField.value="POST"),a.idField&&(a.idField.value=""),a.formTitle&&(a.formTitle.textContent="材料を追加"),a.submitBtnText&&(a.submitBtnText.textContent="追加"),a.submitBtn&&(a.submitBtn.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),a.submitBtn.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300")),a.cancelBtn&&(a.cancelBtn.style.display="none"),a.errorDiv&&(a.errorDiv.innerHTML=""),a.form.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(t=>{t.classList.remove("border-red-500","dark:border-red-600")}),a.inventorySelect&&(a.inventorySelect.value=""),a.manualNameField&&a.manualNameField.classList.add("hidden"),a.manualNameInput&&(a.manualNameInput.value="",a.manualNameInput.required=!1),a.unitDisplay&&(a.unitDisplay.value="",a.unitDisplay.readOnly=!0,a.unitDisplay.placeholder="品目選択で自動表示",a.unitDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400")),a.priceDisplay&&(a.priceDisplay.value="",a.priceDisplay.readOnly=!0,a.priceDisplay.placeholder="自動計算",a.priceDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400")),a.statusCheckbox&&(a.statusCheckbox.checked=!1,a.statusCheckbox.disabled=!1),a.statusHiddenInput&&(a.statusHiddenInput.value="未購入"),a.nameHiddenInput&&(a.nameHiddenInput.value=""),a.unitHiddenInput&&(a.unitHiddenInput.value=""),a.priceHiddenInput&&(a.priceHiddenInput.value=""),a.unitPriceHiddenInput&&(a.unitPriceHiddenInput.value=""),a.applyToOthersCheckbox&&(a.applyToOthersCheckbox.checked=!1),a.applyToOthersWrapperForAdd&&(a.applyToOthersWrapperForAdd.style.display="block"),F(n)}function P(n,e,a,s){const t=document.querySelector(`#materials-content-${n} table tbody`);if(!t){console.warn(`Table body not found for character materials: ${n}`);return}const o=document.getElementById(`material-row-${e.id}`),d=e.notes?S(b(e.notes)):"-",i=e.price!==null?Number(e.price).toLocaleString()+"円":"-",r=B(),u=`/projects/${s.id}/characters/${n}/materials/${e.id}`;let l='<div class="flex items-center justify-end space-x-1">';const c=s.can_update_materials===void 0?!0:s.can_update_materials,p=s.can_delete_materials===void 0?!0:s.can_delete_materials;c&&(l+=`
            <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-material-btn"
                    title="編集" data-id="${e.id}"
                    data-inventory_item_id="${e.inventory_item_id||""}"
                    data-name="${b(e.name||"")}" data-price="${e.price||""}"
                    data-unit="${b(e.unit||"")}" data-unit_price_at_creation="${e.unit_price_at_creation||""}"
                    data-quantity_needed="${b(e.quantity_needed||"")}"
                    data-status="${b(e.status||"未購入")}" data-notes="${b(e.notes||"")}">
                <i class="fas fa-edit fa-sm"></i>
            </button>`),p&&(l+=`
            <form action="/projects/${s.id}/characters/${n}/materials/${e.id}"
                  method="POST" class="delete-material-form" data-id="${e.id}" onsubmit="return false;">
                <input type="hidden" name="_token" value="${r}"><input type="hidden" name="_method" value="DELETE">
                <button type="submit" class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300" title="削除">
                    <i class="fas fa-trash fa-sm"></i>
                </button>
            </form>`),l+="</div>";let m;(s.can_manage_materials===void 0?!0:s.can_manage_materials)?e.inventory_item_id?m='<span class="text-xs px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">購入済</span>':m=`
                <input type="checkbox" id="material-status-checkbox-${e.id}"
                    class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 dark:bg-gray-900 dark:border-gray-600 material-status-checkbox"
                    data-url="${u}" data-id="${e.id}" data-character-id="${n}"
                    ${e.status==="購入済"?"checked":""}>`:m=`<span class="text-gray-700 dark:text-gray-200">${b(e.status)}</span>`;const v=e.inventory_item?e.inventory_item.name:e.name,g=e.unit||(e.inventory_item?e.inventory_item.unit:"");let h;const y=parseFloat(e.quantity_needed),$=(g||"").toLowerCase();let H=0;if($==="m")H=y%1!==0?1:0;else if(y%1!==0){const k=String(y).split(".")[1]||"";H=Math.min(k.length,2)}h=Number(y).toFixed(H);const q=`
        <td class="px-2 py-1.5 whitespace-nowrap text-center text-gray-400 drag-handle">
            <i class="fas fa-grip-vertical"></i>
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap">${m}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-name">
            ${b(v)} ${e.inventory_item_id?'<span class="text-xs text-gray-400">(在庫品)</span>':""}
        </td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-unit">${b(h+" "+g)}</td>

        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-price">${i}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 break-words text-left leading-tight material-notes" style="min-width: 150px;">${d}</td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">${l}</td>
    `;if(a&&o)o.innerHTML=q;else if(!a){const k=document.createElement("tr");k.id=`material-row-${e.id}`,k.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),k.innerHTML=q;const M=t.querySelector('td[colspan="7"]');M&&M.parentElement.remove(),t.appendChild(k)}}function K(n,e,a,s){const t=T(e);if(!t||!t.form){console.warn(`Material form elements not found for character ID: ${e}`);return}const o=t.storeUrl;t.inventorySelect&&t.inventorySelect.addEventListener("change",function(){F(e)}),t.quantityInput&&t.quantityInput.addEventListener("input",function(){w(e)}),t.priceDisplay&&(t.priceDisplay.addEventListener("input",function(){this.readOnly||w(e)}),t.priceDisplay.addEventListener("blur",function(){if(!this.readOnly){let d=this.value.replace(/[円,]/g,"");this.value=!isNaN(parseFloat(d))&&isFinite(d)?parseFloat(d).toLocaleString()+"円":"",w(e)}})),t.unitDisplay&&t.unitDisplay.addEventListener("input",function(){!this.readOnly&&t.unitHiddenInput&&(t.unitHiddenInput.value=this.value)}),t.manualNameInput&&t.manualNameInput.addEventListener("input",function(){t.nameHiddenInput&&(t.nameHiddenInput.value=this.value)}),t.statusCheckbox&&t.statusCheckbox.addEventListener("change",function(){t.statusHiddenInput&&(t.statusHiddenInput.value=this.checked?"購入済":"未購入")}),F(e),n.addEventListener("click",function(d){const i=d.target.closest(".edit-material-btn"),r=s.can_update_materials===void 0?!0:s.can_update_materials;if(i&&r){d.preventDefault(),C(e,o),t.formTitle&&(t.formTitle.textContent="材料を編集"),t.form.setAttribute("action",`/projects/${s.id}/characters/${e}/materials/${i.dataset.id}`),t.methodField&&(t.methodField.value="PUT"),t.idField&&(t.idField.value=i.dataset.id),t.applyToOthersWrapperForAdd&&(t.applyToOthersWrapperForAdd.style.display="none");const c=i.dataset.inventory_item_id,p=i.dataset.status;c&&c!=="null"&&c!==""?t.inventorySelect.value=c:t.inventorySelect.value="manual_input",t.inventorySelect.dispatchEvent(new Event("change")),setTimeout(()=>{if((!c||c==="null"||c==="")&&(t.manualNameInput&&(t.manualNameInput.value=i.dataset.name||""),t.unitDisplay&&(t.unitDisplay.value=i.dataset.unit||"")),t.quantityInput&&(t.quantityInput.value=i.dataset.quantity_needed||""),t.notesInput&&(t.notesInput.value=i.dataset.notes||""),t.priceDisplay){const m=i.dataset.price;t.priceDisplay.value=m&&!isNaN(parseFloat(m))?Number(m).toLocaleString()+"円":""}if(t.priceHiddenInput&&(t.priceHiddenInput.value=i.dataset.price||""),t.unitPriceHiddenInput&&(t.unitPriceHiddenInput.value=i.dataset.unit_price_at_creation||""),t.statusCheckbox&&t.statusHiddenInput){const m=p==="購入済";t.statusCheckbox.checked=m,t.statusHiddenInput.value=p,!c||c==="null"||c===""?t.statusCheckbox.disabled=!1:(t.statusCheckbox.disabled=!0,t.statusCheckbox.checked=!0,t.statusHiddenInput.value="購入済")}w(e)},0),t.submitBtnText&&(t.submitBtnText.textContent="更新"),t.submitBtn&&(t.submitBtn.classList.remove("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"),t.submitBtn.classList.add("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300")),t.cancelBtn&&(t.cancelBtn.style.display="inline-flex"),t.errorDiv&&(t.errorDiv.innerHTML=""),c&&c!=="null"&&c!==""?t.quantityInput&&t.quantityInput.focus():t.manualNameInput&&t.manualNameInput.focus()}const u=d.target.closest(".delete-material-form"),l=s.can_delete_materials===void 0?!0:s.can_delete_materials;u&&l&&(d.preventDefault(),confirm("この材料を本当に削除しますか？")&&_.delete(u.action,{headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(c=>{var p;if(c.data.success){const m=`material-row-${u.dataset.id}`;(p=document.getElementById(m))==null||p.remove(),C(e,o),c.data.costs_updated&&E(s.id,e)}else x(c,"削除に失敗しました。",`material-form-errors-${e}`)}).catch(c=>x(c.response,"削除中にエラーが発生しました。",`material-form-errors-${e}`)))}),t.cancelBtn&&t.cancelBtn.addEventListener("click",function(){C(e,o),t.applyToOthersWrapperForAdd&&(t.applyToOthersWrapperForAdd.style.display="block")}),t.form.addEventListener("submit",function(d){if(d.preventDefault(),t.errorDiv&&(t.errorDiv.innerHTML=""),t.inventorySelect.value==="manual_input")t.nameHiddenInput&&t.manualNameInput&&(t.nameHiddenInput.value=t.manualNameInput.value),t.unitHiddenInput&&t.unitDisplay&&(t.unitHiddenInput.value=t.unitDisplay.value);else{const l=t.inventorySelect.options[t.inventorySelect.selectedIndex];l&&l.value?(t.nameHiddenInput&&(t.nameHiddenInput.value=l.dataset.name||""),t.unitHiddenInput&&(t.unitHiddenInput.value=l.dataset.unit||"")):(t.nameHiddenInput&&(t.nameHiddenInput.value=""),t.unitHiddenInput&&(t.unitHiddenInput.value=""))}t.statusHiddenInput&&t.statusCheckbox&&!t.statusCheckbox.disabled?t.statusHiddenInput.value=t.statusCheckbox.checked?"購入済":"未購入":t.statusHiddenInput&&t.statusCheckbox&&t.statusCheckbox.disabled&&t.inventorySelect.value!==""&&t.inventorySelect.value!=="manual_input"&&(t.statusHiddenInput.value="購入済");const i=new FormData(t.form),r=t.form.getAttribute("action"),u=t.methodField&&t.methodField.value==="PUT";!u&&t.applyToOthersCheckbox&&t.applyToOthersCheckbox.checked?i.append("apply_to_other_characters","1"):i.delete("apply_to_other_characters"),i.delete("update_same_name_on_others"),_({method:"post",url:r,data:i,headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(l=>{if(l.data.success){let c=l.data.material;l.data.materials_data&&Array.isArray(l.data.materials_data)&&(c=l.data.materials_data.find(p=>String(p.character_id)===String(e)&&(u?String(p.id)===t.idField.value:!0))||l.data.materials_data[0]),c&&P(e,c,u,s),C(e,o),l.data.costs_updated_for_characters&&Array.isArray(l.data.costs_updated_for_characters)?l.data.costs_updated_for_characters.forEach(p=>E(s.id,p)):l.data.costs_updated&&E(s.id,e),l.data.message&&console.log("Server message:",l.data.message)}else x(l,l.data.message||"処理に失敗しました。",`material-form-errors-${e}`,l.data.errors)}).catch(l=>{var c,p;return x(l.response,"送信中にエラーが発生しました。",`material-form-errors-${e}`,(p=(c=l.response)==null?void 0:c.data)==null?void 0:p.errors)})}),n.addEventListener("change",function(d){const i=d.target.closest(".material-status-checkbox");if(i&&i.dataset.characterId===String(e)){if(!(s.can_manage_materials===void 0?!0:s.can_manage_materials)){d.preventDefault(),i.checked=!i.checked,alert("ステータスを変更する権限がありません。");return}const u=i.dataset.id,l=i.checked?"購入済":"未購入",c=i.dataset.url,p=!i.checked;console.log(`[Material Status Change] ID: ${u}, Intended Status: ${l}, Original Checked: ${p}`),_.put(c,{status:l},{headers:{"X-CSRF-TOKEN":a,Accept:"application/json","Content-Type":"application/json"}}).then(m=>{if(console.log(`[Material Status Change Response] ID: ${u}`,JSON.stringify(m.data)),m.data.success&&m.data.material){console.log(`[SUCCESS] Redrawing row for ${u} with status from server: ${m.data.material.status}`),P(e,m.data.material,!0,s);const f=document.getElementById(`material-status-checkbox-${u}`);f?console.log(`Checkbox ${u} state after redraw: ${f.checked} (Server status: ${m.data.material.status})`):console.warn(`Checkbox ${u} not found after redraw.`),m.data.costs_updated&&(console.log(`Refreshing costs for char ${e}`),E(s.id,e))}else console.error(`[ERROR/UNEXPECTED] ID: ${u}, ServerSuccess: ${m.data.success}, MaterialData: ${!!m.data.material}`),x(m,m.data.message||"ステータス更新に失敗しました(レスポンス形式不正)。",`material-form-errors-${e}`),i&&(i.checked=p),alert(m.data.message||"ステータス更新に失敗しました。表示を元に戻します。")}).catch(m=>{console.error(`[CATCH ERROR] ID: ${u}`,m.response||m),x(m.response,"ステータス更新中に通信エラーが発生しました。",`material-form-errors-${e}`),i&&(i.checked=p),alert("ステータス更新中にエラーが発生しました。表示を元に戻します。")})}})}function A(n){const e=document.getElementById(`costs-content-${n}`);if(!e)return;const a=e.querySelector("table tbody");if(!a)return;let s=0;a.querySelectorAll('tr[id^="cost-row-"]').forEach(o=>{const d=o.querySelector(".cost-amount");d&&(s+=parseFloat(String(d.textContent).replace(/[^0-9.-]+/g,""))||0)});const t=e.querySelector(".p-3.rounded-md span.font-semibold");if(t){t.textContent=Number(s).toLocaleString()+"円";const o=t.closest(".p-3.rounded-md");o&&(s>0?(o.classList.remove("bg-gray-100","text-gray-700","dark:bg-gray-700/30","dark:text-gray-300"),o.classList.add("bg-green-100","text-green-700","dark:bg-green-700/30","dark:text-green-200")):(o.classList.remove("bg-green-100","text-green-700","dark:bg-green-700/30","dark:text-green-200"),o.classList.add("bg-gray-100","text-gray-700","dark:bg-gray-700/30","dark:text-gray-300")))}}function L(n,e){const a=document.getElementById(`cost-form-${n}`);if(!a)return;a.reset(),a.setAttribute("action",e);const s=document.getElementById(`cost-form-method-${n}`);s&&(s.value="POST");const t=document.getElementById(`cost-form-id-${n}`);t&&(t.value="");const o=document.getElementById(`cost-form-title-${n}`);o&&(o.textContent="コストを追加");const d=document.getElementById(`cost-form-submit-btn-text-${n}`);d&&(d.textContent="追加");const i=document.getElementById(`cost-form-submit-btn-${n}`);i&&(i.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),i.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"));const r=document.getElementById(`cost-form-cancel-btn-${n}`);r&&(r.style.display="none");const u=document.getElementById(`cost-form-errors-${n}`);u&&(u.innerHTML=""),a.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(c=>{c.classList.remove("border-red-500","dark:border-red-600")});const l=a.querySelector(`#cost_cost_date_input-${n}`)||a.querySelector('[id^="cost_cost_date_input"]');if(l&&!(t&&t.value)){const c=new Date,p=c.getFullYear(),m=String(c.getMonth()+1).padStart(2,"0"),f=String(c.getDate()).padStart(2,"0");l.value=`${p}-${m}-${f}`}}function X(n,e,a,s){const t=document.querySelector(`#costs-content-${n} table tbody`);if(!t)return;const o=document.getElementById(`cost-row-${e.id}`),d=e.notes?S(b(e.notes)):"-",i=Number(e.amount).toLocaleString()+"円";let r="-";if(e.cost_date&&typeof e.cost_date=="string"){const f=new Date(e.cost_date);isNaN(f.getTime())?r="日付エラー":r=f.toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",timeZone:"Asia/Tokyo"})}else r="日付なし";const u=B();let l="",c="bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-100";e.type==="材料費"?c="bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100":e.type==="作業費"&&(c="bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100"),l=`<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${c}">${b(e.type)}</span>`;let p='<div class="flex items-center justify-end space-x-1">';p+=`
        <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-cost-btn"
                title="編集"
                data-id="${e.id}"
                data-cost_date="${e.cost_date?e.cost_date.substring(0,10):""}"
                data-type="${b(e.type||"")}"
                data-amount="${e.amount||""}"
                data-item_description="${b(e.item_description||"")}"
                data-notes="${b(e.notes||"")}">
            <i class="fas fa-edit fa-sm"></i>
        </button>`,p+=`
        <form action="/projects/${s.id}/characters/${n}/costs/${e.id}"
              method="POST" class="delete-cost-form"
              data-id="${e.id}"
              onsubmit="return false;">
            <input type="hidden" name="_token" value="${u}">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit"
                class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                title="削除">
                <i class="fas fa-trash fa-sm"></i>
            </button>
        </form>`,p+="</div>";const m=`
        <td class="px-2 py-1.5 whitespace-nowrap text-center text-gray-400 drag-handle">
            <i class="fas fa-grip-vertical"></i>
        </td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 cost-cost_date">${b(r)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap cost-type">${l}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 cost-amount">${i}</td>
        <td class="px-4 py-1.5 whitespace-normal break-words text-gray-700 dark:text-gray-200 cost-item_description">${b(e.item_description)}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 whitespace-pre-wrap break-words text-left leading-tight cost-notes" style="min-width: 150px;">
            ${d}
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">
            ${p}
        </td>
    `;if(a&&o)o.innerHTML=m;else if(!a){const f=document.createElement("tr");f.id=`cost-row-${e.id}`,f.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),f.innerHTML=m;const v=t.querySelector('td[colspan="6"]');v&&v.parentElement.remove(),t.appendChild(f)}A(n)}function z(n,e,a,s){const t=document.getElementById(`cost-form-${e}`);if(!t)return;const o=t.dataset.storeUrl,d=document.getElementById(`cost-form-title-${e}`),i=document.getElementById(`cost-form-submit-btn-${e}`),r=document.getElementById(`cost-form-submit-btn-text-${e}`),u=document.getElementById(`cost-form-cancel-btn-${e}`),l=document.getElementById(`cost-form-method-${e}`),c=document.getElementById(`cost-form-id-${e}`),p=`cost-form-errors-${e}`;n.addEventListener("click",function(m){const f=m.target.closest(".edit-cost-btn");if(f){m.preventDefault(),d&&(d.textContent="コストを編集"),t.setAttribute("action",`/projects/${s.id}/characters/${e}/costs/${f.dataset.id}`),l&&(l.value="PUT"),c&&(c.value=f.dataset.id),t.querySelector(`[id="cost_cost_date_input-${e}"]`).value=f.dataset.cost_date,t.querySelector(`[id="cost_type_input-${e}"]`).value=f.dataset.type,t.querySelector(`[id="cost_amount_input-${e}"]`).value=f.dataset.amount,t.querySelector(`[id="cost_item_description_input-${e}"]`).value=f.dataset.item_description,t.querySelector(`[id="cost_notes_input-${e}"]`).value=f.dataset.notes||"",r&&(r.textContent="更新"),i&&(i.classList.remove("bg-green-500","hover:bg-green-600"),i.classList.add("bg-yellow-500","hover:bg-yellow-600")),u&&(u.style.display="inline-flex");const g=document.getElementById(p);g&&(g.innerHTML=""),t.querySelector(`[id="cost_cost_date_input-${e}"]`).focus()}const v=m.target.closest(".delete-cost-form");v&&(m.preventDefault(),confirm("このコストを本当に削除しますか？")&&_.delete(v.action,{headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(g=>{if(g.data.success){const h=`cost-row-${v.dataset.id}`,y=document.getElementById(h);y&&y.remove(),L(e,o),A(e),g.data.material_status_updated}else x(g,"削除に失敗しました。",p)}).catch(g=>{x(g.response,"削除中にエラーが発生しました。",p)}))}),u&&u.addEventListener("click",function(){L(e,o)}),t.addEventListener("submit",function(m){m.preventDefault();const f=document.getElementById(p);f&&(f.innerHTML="");const v=new FormData(t),g=t.getAttribute("action");let h="post";l&&l.value==="PUT"&&v.append("_method","PUT"),_({method:h,url:g,data:v,headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(y=>{if(y.data.success&&y.data.cost){const $=l&&l.value==="PUT";X(e,y.data.cost,$,s),L(e,t.dataset.storeUrl),y.data.material_status_updated}else x(y,"コスト処理に失敗しました。",p)}).catch(y=>{x(y.response,"コスト送信中にエラーが発生しました。",p)})})}function J(){const n=document.getElementById("project-show-main-container");if(!n){console.error("[project-show-main.js] CRITICAL: mainContainer not found. Exiting initialization.");return}const e=n.dataset.projectId,a=B();let s={id:e};if(n.dataset.project)try{s=JSON.parse(n.dataset.project)}catch(o){console.error("[project-show-main.js] Failed to parse project data from HTML attribute:",o)}n.addEventListener("change",function(o){const d=o.target.closest(".project-flag-select, .project-status-select");d&&d.closest(".lg\\:col-span-1")&&U(d,a)}),n.querySelectorAll(".js-character-card").forEach(o=>{const d=o.querySelector('[id^="measurements-content-"]'),i=o.querySelector('[id^="materials-content-"]'),r=o.querySelector('[id^="costs-content-"]');let u=null;d?u=d.id.split("-").pop():i?u=i.id.split("-").pop():r&&(u=r.id.split("-").pop()),u?(d&&W(d,u,a,s),i&&K(i,u,a,s),r&&z(r,u,a,s)):console.warn("[project-show-main.js] Could not determine characterId for a character card. Skipping interactions init.",o)})}document.getElementById("project-show-main-container")&&J();
