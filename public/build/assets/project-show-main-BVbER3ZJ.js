import{a as $}from"./app-Cw83AOf_.js";const P={0:{tooltip:"未納品",icon:"fa-truck",colorClass:"text-yellow-500 dark:text-yellow-400"},1:{tooltip:"納品済み",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"}},R={Pending:{tooltip:"未払い",icon:"fa-clock",colorClass:"text-yellow-500 dark:text-yellow-400"},Processing:{tooltip:"支払い中",icon:"fa-hourglass-half",colorClass:"text-blue-500 dark:text-blue-400"},Completed:{tooltip:"支払完了",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"},"Partially Paid":{tooltip:"一部支払い",icon:"fa-adjust",colorClass:"text-orange-500 dark:text-orange-400"},Overdue:{tooltip:"期限切れ",icon:"fa-exclamation-triangle",colorClass:"text-red-500 dark:text-red-400"},Cancelled:{tooltip:"キャンセル",icon:"fa-ban",colorClass:"text-gray-500 dark:text-gray-400"},Refunded:{tooltip:"返金済み",icon:"fa-undo",colorClass:"text-purple-500 dark:text-purple-400"},"On Hold":{tooltip:"一時停止中",icon:"fa-pause-circle",colorClass:"text-indigo-500 dark:text-indigo-400"},"":{tooltip:"未設定",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"}},N={not_started:{tooltip:"未着手",icon:"fa-minus-circle",colorClass:"text-gray-500 dark:text-gray-400"},in_progress:{tooltip:"進行中",icon:"fa-play-circle",colorClass:"text-blue-500 dark:text-blue-400"},completed:{tooltip:"完了",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"},on_hold:{tooltip:"一時停止中",icon:"fa-pause-circle",colorClass:"text-yellow-500 dark:text-yellow-400"},cancelled:{tooltip:"キャンセル",icon:"fa-times-circle",colorClass:"text-red-500 dark:text-red-400"},"":{tooltip:"未設定",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"}};function O(n,e,a){if(n){const s=Object.keys(a).includes("")?"":Object.keys(a)[0],t=a[e]||a[s]||{tooltip:e||"-",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"};n.title=t.tooltip;const r=n.querySelector("i");if(r){const u=Array.from(r.classList).filter(l=>l.startsWith("fa-")||l.startsWith("text-")||l.startsWith("dark:text-"));r.classList.remove(...u);const i=t.icon.split(" ");r.classList.add("fas",...i),t.colorClass&&t.colorClass.split(" ").forEach(l=>r.classList.add(l))}else n.innerHTML=`<i class="fas ${t.icon} ${t.colorClass||""}"></i>`}}function D(n,e){n.dataset.projectId;const a=n.name,s=n.value,t=n.dataset.url,r=n.dataset.iconTarget,u=document.getElementById(r);$.patch(t,{[a]:s},{headers:{"X-CSRF-TOKEN":e,Accept:"application/json","Content-Type":"application/json"}}).then(i=>{if(i.data.success){if(u){let l;a==="delivery_flag"?l=P:a==="payment_flag"?l=R:a==="status"&&(l=N),l&&O(u,s,l)}if(i.data.updated_project_status!==void 0){const l=n.dataset.statusTargetSelect,d=n.dataset.statusTargetIcon;if(l){const o=document.getElementById(l);o&&(o.value=i.data.updated_project_status)}if(d){const o=document.getElementById(d);o&&O(o,i.data.updated_project_status,N)}}}else alert("更新に失敗しました: "+(i.data.message||"サーバーエラー"))}).catch(i=>{let l="更新中にエラーが発生しました。";i.response&&i.response.data&&i.response.data.message?l+=`
`+i.response.data.message:i.response&&i.response.status&&(l+=` (ステータス: ${i.response.status})`),alert(l)})}function x(n,e="処理に失敗しました。",a=null){let s=e,t=null;if(n&&n.data){if(n.data.message&&(typeof n.data.message!="object"||Object.keys(n.data.message).length>0)&&(s=n.data.message),n.data.errors){t=n.data.errors;let u=[];for(const i in t)u.push(t[i].join("; "));u.length>0&&s===e&&(s=u.join(`
`))}}else n&&typeof n=="string"&&(s=n);const r=a?document.getElementById(a):null;if(r&&t){let u='<ul class="list-disc pl-5 text-red-600 dark:text-red-400">';for(const l in t)t[l].forEach(d=>{u+=`<li>${b(d)}</li>`});u+="</ul>",r.innerHTML=u;const i=r.closest("form");i&&Object.keys(t).forEach(l=>{const d=l.includes(".")?l.split(".").map((c,p)=>p===0?c:`[${c}]`).join(""):l,o=i.querySelector(`[name="${d}"], [name="${d}[]"]`);o&&o.classList.add("border-red-500","dark:border-red-600")})}else r&&s?r.innerHTML=`<p class="text-red-600 dark:text-red-400">${B(b(String(s)))}</p>`:s&&!r&&alert(String(s))}function E(){const n=document.querySelector('meta[name="csrf-token"]');return n?n.getAttribute("content"):null}function b(n){return n===null||typeof n>"u"?"":String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function B(n){return typeof n>"u"||n===null?"":String(n).replace(/(\r\n|\n\r|\r|\n)/g,"<br>$1")}function C(n,e){const a=document.getElementById(`costs-content-${e}`);if(!a){console.warn(`Could not find costs tab container for character: ${e}`);return}const s=`/projects/${n}/characters/${e}/costs-partial`;$.get(s).then(t=>{a.innerHTML=t.data}).catch(t=>{console.error("Error refreshing costs list:",t),a.innerHTML='<p class="text-red-500 p-4">コスト情報の更新に失敗しました。</p>'})}function H(n,e){const a=document.getElementById(`measurement-form-${n}`);if(!a){console.warn(`Measurement form not found for reset: measurement-form-${n}`);return}a.reset(),a.setAttribute("action",e);const s=document.getElementById(`measurement-form-method-${n}`);s&&(s.value="POST");const t=document.getElementById(`measurement-form-id-${n}`);t&&(t.value="");const r=document.getElementById(`measurement-form-title-${n}`);r&&(r.textContent="採寸データを追加");const u=document.getElementById(`measurement-form-submit-btn-text-${n}`);u&&(u.textContent="追加");const i=document.getElementById(`measurement-form-submit-btn-${n}`);i&&(i.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),i.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"));const l=document.getElementById(`measurement-form-cancel-btn-${n}`);l&&(l.style.display="none");const d=document.getElementById(`measurement-form-errors-${n}`);d&&(d.innerHTML=""),a.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(o=>{o.classList.remove("border-red-500","dark:border-red-600")})}function U(n,e,a,s){const t=document.querySelector(`#measurements-content-${n} table tbody`);if(!t){console.warn(`Measurement table body not found for character ${n}`);return}const r=document.getElementById(`measurement-row-${e.id}`),u=e.notes?B(b(e.notes)):"-",i=E();let l='<div class="flex items-center justify-end space-x-1">';l+=`
        <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-measurement-btn"
                title="編集"
                data-id="${e.id}"
                data-item="${b(e.item||"")}"
                data-value="${b(e.value||"")}"
                data-notes="${b(e.notes||"")}">
            <i class="fas fa-edit fa-sm"></i>
        </button>`,l+=`
        <form action="/projects/${s.id}/characters/${n}/measurements/${e.id}"
              method="POST" class="delete-measurement-form"
              data-id="${e.id}"
              onsubmit="return false;">
            <input type="hidden" name="_token" value="${i}">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit"
                class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                title="削除">
                <i class="fas fa-trash fa-sm"></i>
            </button>
        </form>`,l+="</div>";const d=`
        <td class="px-2 py-1.5 whitespace-nowrap text-center text-gray-400 drag-handle">
            <i class="fas fa-grip-vertical"></i>
        </td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 measurement-item">${b(e.item)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 measurement-value">${b(e.value)}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 whitespace-pre-wrap break-words text-left leading-tight measurement-notes" style="min-width: 150px;">
            ${u}
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">
            ${l}
        </td>
    `;if(a&&r)r.innerHTML=d;else if(!a){const o=document.createElement("tr");o.id=`measurement-row-${e.id}`,o.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),o.innerHTML=d;const c=t.querySelector('td[colspan="4"]');c&&c.parentElement.remove(),t.appendChild(o)}}function K(n,e,a,s){const t=document.getElementById(`measurement-form-${e}`);if(!t){console.warn(`Measurement form not found for character ${e}`);return}const r=t.dataset.storeUrl,u=document.getElementById(`measurement-form-title-${e}`),i=document.getElementById(`measurement-form-submit-btn-${e}`),l=document.getElementById(`measurement-form-submit-btn-text-${e}`),d=document.getElementById(`measurement-form-cancel-btn-${e}`),o=document.getElementById(`measurement-form-method-${e}`),c=document.getElementById(`measurement-form-id-${e}`),p=`measurement-form-errors-${e}`;n.addEventListener("click",function(m){const f=m.target.closest(".edit-measurement-btn");if(f){m.preventDefault(),u&&(u.textContent="採寸データを編集"),t.setAttribute("action",`/projects/${s.id}/characters/${e}/measurements/${f.dataset.id}`),o&&(o.value="PUT"),c&&(c.value=f.dataset.id);const g=t.querySelector(`[id="measurement_item_input-${e}"]`),h=t.querySelector(`[id="measurement_value_input-${e}"]`),y=t.querySelector(`[id="measurement_notes_input-${e}"]`);g&&(g.value=f.dataset.item),h&&(h.value=f.dataset.value),y&&(y.value=f.dataset.notes||""),l&&(l.textContent="更新"),i&&(i.classList.remove("bg-green-500","hover:bg-green-600"),i.classList.add("bg-yellow-500","hover:bg-yellow-600")),d&&(d.style.display="inline-flex");const _=document.getElementById(p);_&&(_.innerHTML=""),g&&g.focus()}const v=m.target.closest(".delete-measurement-form");v&&(m.preventDefault(),confirm("この採寸データを本当に削除しますか？")&&$.delete(v.action,{headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(g=>{if(g.data.success){const h=`measurement-row-${v.dataset.id}`,y=document.getElementById(h);y&&y.remove(),H(e,r)}else x(g,"削除に失敗しました。",p)}).catch(g=>{x(g.response,"削除中にエラーが発生しました。",p)}))}),d&&d.addEventListener("click",function(){H(e,r)}),t.addEventListener("submit",function(m){m.preventDefault();const f=document.getElementById(p);f&&(f.innerHTML="");const v=new FormData(t),g=t.getAttribute("action");let h="post";document.getElementById(`measurement-form-method-${e}`).value==="PUT"&&v.append("_method","PUT"),$({method:h,url:g,data:v,headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(y=>{if(y.data.success&&y.data.measurement){const _=document.getElementById(`measurement-form-method-${e}`).value==="PUT";U(e,y.data.measurement,_,s),H(e,r)}else x(y,"処理に失敗しました。",p)}).catch(y=>{x(y.response,"送信中にエラーが発生しました。",p)})})}function T(n){const e=document.getElementById(`material-form-${n}`);return e?{form:e,inventorySelect:document.getElementById(`inventory_item_id_input-${n}`),manualNameField:document.getElementById(`manual_material_name_field-${n}`),manualNameInput:document.getElementById(`manual_material_name_input-${n}`),unitDisplay:document.getElementById(`material_unit_display-${n}`),quantityInput:document.getElementById(`material_quantity_input-${n}`),priceDisplay:document.getElementById(`material_price_display-${n}`),notesInput:document.getElementById(`material_notes_input-${n}`),statusCheckbox:document.getElementById(`material_status_checkbox_for_form-${n}`),methodField:document.getElementById(`material-form-method-${n}`),idField:document.getElementById(`material-form-id-${n}`),nameHiddenInput:document.getElementById(`material_name_hidden_input-${n}`),unitHiddenInput:document.getElementById(`material_unit_hidden_input-${n}`),priceHiddenInput:document.getElementById(`material_price_hidden_input-${n}`),unitPriceHiddenInput:document.getElementById(`material_unit_price_hidden_input-${n}`),statusHiddenInput:document.getElementById(`material_status_hidden_input-${n}`),formTitle:document.getElementById(`material-form-title-${n}`),submitBtn:document.getElementById(`material-form-submit-btn-${n}`),submitBtnText:document.getElementById(`material-form-submit-btn-text-${n}`),cancelBtn:document.getElementById(`material-form-cancel-btn-${n}`),errorDiv:document.getElementById(`material-form-errors-${n}`),storeUrl:e.dataset.storeUrl,applyToOthersCheckbox:document.getElementById(`apply_material_to_other_characters-${n}`),applyToOthersWrapperForAdd:document.getElementById(`apply_to_others_wrapper_for_add_material-${n}`)}:null}function w(n){const e=T(n);if(!e||!e.quantityInput||!e.priceDisplay||!e.priceHiddenInput||!e.unitPriceHiddenInput)return;const a=e.inventorySelect.options[e.inventorySelect.selectedIndex],s=parseFloat(e.quantityInput.value);if(a.value&&a.value!=="manual_input"){const t=parseFloat(a.dataset.avg_price);if(!isNaN(t)&&!isNaN(s)&&s>0){const r=t*s;e.priceDisplay.value=Math.round(r).toLocaleString()+"円",e.priceHiddenInput.value=Math.round(r),e.unitPriceHiddenInput.value=t}else e.priceDisplay.value="",e.priceHiddenInput.value="",e.unitPriceHiddenInput.value=""}else if(a.value==="manual_input"){const t=e.priceDisplay.value.replace(/[円,]/g,""),r=parseFloat(t);isNaN(r)?(e.priceHiddenInput.value="",e.unitPriceHiddenInput.value=""):(e.priceHiddenInput.value=r,!isNaN(s)&&s>0?e.unitPriceHiddenInput.value=r/s:e.unitPriceHiddenInput.value="")}else e.priceDisplay.value="",e.priceHiddenInput.value="",e.unitPriceHiddenInput.value=""}function F(n){const e=T(n);if(!e)return;const a=e.inventorySelect.value,s=e.inventorySelect.options[e.inventorySelect.selectedIndex];a==="manual_input"?(e.manualNameField.classList.remove("hidden"),e.manualNameInput.required=!0,e.unitDisplay.readOnly=!1,e.unitDisplay.placeholder="単位を入力 (例: 個, m)",e.unitDisplay.classList.remove("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.priceDisplay.readOnly=!1,e.priceDisplay.placeholder="合計価格を入力 (例: 1000)",e.priceDisplay.classList.remove("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.statusCheckbox.checked=!1,e.statusCheckbox.disabled=!1,e.statusHiddenInput.value="未購入"):a?(e.manualNameField.classList.add("hidden"),e.manualNameInput.required=!1,e.manualNameInput.value="",e.unitDisplay.readOnly=!0,e.unitDisplay.placeholder="品目選択で自動表示",e.unitDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.unitDisplay.value=s.dataset.unit||"",e.priceDisplay.readOnly=!0,e.priceDisplay.placeholder="自動計算",e.priceDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.statusCheckbox.checked=!0,e.statusCheckbox.disabled=!0,e.statusHiddenInput.value="購入済",e.nameHiddenInput.value=s.dataset.name||"",e.unitHiddenInput.value=s.dataset.unit||""):(e.manualNameField.classList.add("hidden"),e.manualNameInput.required=!1,e.manualNameInput.value="",e.unitDisplay.readOnly=!0,e.unitDisplay.placeholder="品目選択で自動表示",e.unitDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.unitDisplay.value="",e.priceDisplay.readOnly=!0,e.priceDisplay.placeholder="自動計算",e.priceDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.priceDisplay.value="",e.statusCheckbox.checked=!1,e.statusCheckbox.disabled=!1,e.statusHiddenInput.value="未購入",e.nameHiddenInput.value="",e.unitHiddenInput.value=""),w(n)}function S(n,e){const a=T(n);if(!a)return;const s=e||a.storeUrl;a.form.reset(),a.form.setAttribute("action",s),a.methodField&&(a.methodField.value="POST"),a.idField&&(a.idField.value=""),a.formTitle&&(a.formTitle.textContent="材料を追加"),a.submitBtnText&&(a.submitBtnText.textContent="追加"),a.submitBtn&&(a.submitBtn.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),a.submitBtn.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300")),a.cancelBtn&&(a.cancelBtn.style.display="none"),a.errorDiv&&(a.errorDiv.innerHTML=""),a.form.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(t=>{t.classList.remove("border-red-500","dark:border-red-600")}),a.inventorySelect&&(a.inventorySelect.value=""),a.manualNameField&&a.manualNameField.classList.add("hidden"),a.manualNameInput&&(a.manualNameInput.value="",a.manualNameInput.required=!1),a.unitDisplay&&(a.unitDisplay.value="",a.unitDisplay.readOnly=!0,a.unitDisplay.placeholder="品目選択で自動表示",a.unitDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400")),a.priceDisplay&&(a.priceDisplay.value="",a.priceDisplay.readOnly=!0,a.priceDisplay.placeholder="自動計算",a.priceDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400")),a.statusCheckbox&&(a.statusCheckbox.checked=!1,a.statusCheckbox.disabled=!1),a.statusHiddenInput&&(a.statusHiddenInput.value="未購入"),a.nameHiddenInput&&(a.nameHiddenInput.value=""),a.unitHiddenInput&&(a.unitHiddenInput.value=""),a.priceHiddenInput&&(a.priceHiddenInput.value=""),a.unitPriceHiddenInput&&(a.unitPriceHiddenInput.value=""),a.applyToOthersCheckbox&&(a.applyToOthersCheckbox.checked=!1),a.applyToOthersWrapperForAdd&&(a.applyToOthersWrapperForAdd.style.display="block"),F(n)}function j(n,e,a,s){const t=document.querySelector(`#materials-content-${n} table tbody`);if(!t){console.warn(`Table body not found for character materials: ${n}`);return}const r=document.getElementById(`material-row-${e.id}`),u=e.notes?B(b(e.notes)):"-",i=e.price!==null?Number(e.price).toLocaleString()+"円":"-",l=E(),d=`/projects/${s.id}/characters/${n}/materials/${e.id}`;let o='<div class="flex items-center justify-end space-x-1">';const c=s.can_update_materials===void 0?!0:s.can_update_materials,p=s.can_delete_materials===void 0?!0:s.can_delete_materials;c&&(o+=`
            <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-material-btn"
                    title="編集" data-id="${e.id}"
                    data-inventory_item_id="${e.inventory_item_id||""}"
                    data-name="${b(e.name||"")}" data-price="${e.price||""}"
                    data-unit="${b(e.unit||"")}" data-unit_price_at_creation="${e.unit_price_at_creation||""}"
                    data-quantity_needed="${b(e.quantity_needed||"")}"
                    data-status="${b(e.status||"未購入")}" data-notes="${b(e.notes||"")}">
                <i class="fas fa-edit fa-sm"></i>
            </button>`),p&&(o+=`
            <form action="/projects/${s.id}/characters/${n}/materials/${e.id}"
                  method="POST" class="delete-material-form" data-id="${e.id}" onsubmit="return false;">
                <input type="hidden" name="_token" value="${l}"><input type="hidden" name="_method" value="DELETE">
                <button type="submit" class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300" title="削除">
                    <i class="fas fa-trash fa-sm"></i>
                </button>
            </form>`),o+="</div>";let m;(s.can_manage_materials===void 0?!0:s.can_manage_materials)?e.inventory_item_id?m='<span class="text-xs px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">購入済</span>':m=`
                <input type="checkbox" id="material-status-checkbox-${e.id}"
                    class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 dark:bg-gray-900 dark:border-gray-600 material-status-checkbox"
                    data-url="${d}" data-id="${e.id}" data-character-id="${n}"
                    ${e.status==="購入済"?"checked":""}>`:m=`<span class="text-gray-700 dark:text-gray-200">${b(e.status)}</span>`;const v=e.inventory_item?e.inventory_item.name:e.name,g=e.unit||(e.inventory_item?e.inventory_item.unit:"");let h;const y=parseFloat(e.quantity_needed),_=(g||"").toLowerCase();let I=0;if(_==="m")I=y%1!==0?1:0;else if(y%1!==0){const k=String(y).split(".")[1]||"";I=Math.min(k.length,2)}h=Number(y).toFixed(I);const q=`
        <td class="px-2 py-1.5 whitespace-nowrap text-center text-gray-400 drag-handle">
            <i class="fas fa-grip-vertical"></i>
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap">${m}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-name">
            ${b(v)} ${e.inventory_item_id?'<span class="text-xs text-gray-400">(在庫品)</span>':""}
        </td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-unit">${b(h+" "+g)}</td>

        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-price">${i}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 break-words text-left leading-tight material-notes" style="min-width: 150px;">${u}</td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">${o}</td>
    `;if(a&&r)r.innerHTML=q;else if(!a){const k=document.createElement("tr");k.id=`material-row-${e.id}`,k.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),k.innerHTML=q;const M=t.querySelector('td[colspan="7"]');M&&M.parentElement.remove(),t.appendChild(k)}}function X(n,e,a,s){const t=T(e);if(!t||!t.form){console.warn(`Material form elements not found for character ID: ${e}`);return}const r=t.storeUrl;t.inventorySelect&&t.inventorySelect.addEventListener("change",function(){F(e)}),t.quantityInput&&t.quantityInput.addEventListener("input",function(){w(e)}),t.priceDisplay&&(t.priceDisplay.addEventListener("input",function(){this.readOnly||w(e)}),t.priceDisplay.addEventListener("blur",function(){if(!this.readOnly){let u=this.value.replace(/[円,]/g,"");this.value=!isNaN(parseFloat(u))&&isFinite(u)?parseFloat(u).toLocaleString()+"円":"",w(e)}})),t.unitDisplay&&t.unitDisplay.addEventListener("input",function(){!this.readOnly&&t.unitHiddenInput&&(t.unitHiddenInput.value=this.value)}),t.manualNameInput&&t.manualNameInput.addEventListener("input",function(){t.nameHiddenInput&&(t.nameHiddenInput.value=this.value)}),t.statusCheckbox&&t.statusCheckbox.addEventListener("change",function(){t.statusHiddenInput&&(t.statusHiddenInput.value=this.checked?"購入済":"未購入")}),F(e),n.addEventListener("click",function(u){const i=u.target.closest(".edit-material-btn"),l=s.can_update_materials===void 0?!0:s.can_update_materials;if(i&&l){u.preventDefault(),S(e,r),t.formTitle&&(t.formTitle.textContent="材料を編集"),t.form.setAttribute("action",`/projects/${s.id}/characters/${e}/materials/${i.dataset.id}`),t.methodField&&(t.methodField.value="PUT"),t.idField&&(t.idField.value=i.dataset.id),t.applyToOthersWrapperForAdd&&(t.applyToOthersWrapperForAdd.style.display="none");const c=i.dataset.inventory_item_id,p=i.dataset.status;c&&c!=="null"&&c!==""?t.inventorySelect.value=c:t.inventorySelect.value="manual_input",t.inventorySelect.dispatchEvent(new Event("change")),setTimeout(()=>{if((!c||c==="null"||c==="")&&(t.manualNameInput&&(t.manualNameInput.value=i.dataset.name||""),t.unitDisplay&&(t.unitDisplay.value=i.dataset.unit||"")),t.quantityInput&&(t.quantityInput.value=i.dataset.quantity_needed||""),t.notesInput&&(t.notesInput.value=i.dataset.notes||""),t.priceDisplay){const m=i.dataset.price;t.priceDisplay.value=m&&!isNaN(parseFloat(m))?Number(m).toLocaleString()+"円":""}if(t.priceHiddenInput&&(t.priceHiddenInput.value=i.dataset.price||""),t.unitPriceHiddenInput&&(t.unitPriceHiddenInput.value=i.dataset.unit_price_at_creation||""),t.statusCheckbox&&t.statusHiddenInput){const m=p==="購入済";t.statusCheckbox.checked=m,t.statusHiddenInput.value=p,!c||c==="null"||c===""?t.statusCheckbox.disabled=!1:(t.statusCheckbox.disabled=!0,t.statusCheckbox.checked=!0,t.statusHiddenInput.value="購入済")}w(e)},0),t.submitBtnText&&(t.submitBtnText.textContent="更新"),t.submitBtn&&(t.submitBtn.classList.remove("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"),t.submitBtn.classList.add("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300")),t.cancelBtn&&(t.cancelBtn.style.display="inline-flex"),t.errorDiv&&(t.errorDiv.innerHTML=""),c&&c!=="null"&&c!==""?t.quantityInput&&t.quantityInput.focus():t.manualNameInput&&t.manualNameInput.focus()}const d=u.target.closest(".delete-material-form"),o=s.can_delete_materials===void 0?!0:s.can_delete_materials;d&&o&&(u.preventDefault(),confirm("この材料を本当に削除しますか？")&&$.delete(d.action,{headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(c=>{var p;if(c.data.success){const m=`material-row-${d.dataset.id}`;(p=document.getElementById(m))==null||p.remove(),S(e,r),c.data.costs_updated&&C(s.id,e)}else x(c,"削除に失敗しました。",`material-form-errors-${e}`)}).catch(c=>x(c.response,"削除中にエラーが発生しました。",`material-form-errors-${e}`)))}),t.cancelBtn&&t.cancelBtn.addEventListener("click",function(){S(e,r),t.applyToOthersWrapperForAdd&&(t.applyToOthersWrapperForAdd.style.display="block")}),t.form.addEventListener("submit",function(u){if(u.preventDefault(),t.errorDiv&&(t.errorDiv.innerHTML=""),t.inventorySelect.value==="manual_input")t.nameHiddenInput&&t.manualNameInput&&(t.nameHiddenInput.value=t.manualNameInput.value),t.unitHiddenInput&&t.unitDisplay&&(t.unitHiddenInput.value=t.unitDisplay.value);else{const o=t.inventorySelect.options[t.inventorySelect.selectedIndex];o&&o.value?(t.nameHiddenInput&&(t.nameHiddenInput.value=o.dataset.name||""),t.unitHiddenInput&&(t.unitHiddenInput.value=o.dataset.unit||"")):(t.nameHiddenInput&&(t.nameHiddenInput.value=""),t.unitHiddenInput&&(t.unitHiddenInput.value=""))}t.statusHiddenInput&&t.statusCheckbox&&!t.statusCheckbox.disabled?t.statusHiddenInput.value=t.statusCheckbox.checked?"購入済":"未購入":t.statusHiddenInput&&t.statusCheckbox&&t.statusCheckbox.disabled&&t.inventorySelect.value!==""&&t.inventorySelect.value!=="manual_input"&&(t.statusHiddenInput.value="購入済");const i=new FormData(t.form),l=t.form.getAttribute("action"),d=t.methodField&&t.methodField.value==="PUT";!d&&t.applyToOthersCheckbox&&t.applyToOthersCheckbox.checked?i.append("apply_to_other_characters","1"):i.delete("apply_to_other_characters"),i.delete("update_same_name_on_others"),$({method:"post",url:l,data:i,headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(o=>{if(o.data.success){let c=o.data.material;o.data.materials_data&&Array.isArray(o.data.materials_data)&&(c=o.data.materials_data.find(p=>String(p.character_id)===String(e)&&(d?String(p.id)===t.idField.value:!0))||o.data.materials_data[0]),c&&j(e,c,d,s),S(e,r),o.data.costs_updated_for_characters&&Array.isArray(o.data.costs_updated_for_characters)?o.data.costs_updated_for_characters.forEach(p=>C(s.id,p)):o.data.costs_updated&&C(s.id,e),o.data.message&&console.log("Server message:",o.data.message)}else x(o,o.data.message||"処理に失敗しました。",`material-form-errors-${e}`,o.data.errors)}).catch(o=>{var c,p;return x(o.response,"送信中にエラーが発生しました。",`material-form-errors-${e}`,(p=(c=o.response)==null?void 0:c.data)==null?void 0:p.errors)})}),n.addEventListener("change",function(u){const i=u.target.closest(".material-status-checkbox");if(i&&i.dataset.characterId===String(e)){if(!(s.can_manage_materials===void 0?!0:s.can_manage_materials)){u.preventDefault(),i.checked=!i.checked,alert("ステータスを変更する権限がありません。");return}const d=i.dataset.id,o=i.checked?"購入済":"未購入",c=i.dataset.url,p=!i.checked;console.log(`[Material Status Change] ID: ${d}, Intended Status: ${o}, Original Checked: ${p}`),$.put(c,{status:o},{headers:{"X-CSRF-TOKEN":a,Accept:"application/json","Content-Type":"application/json"}}).then(m=>{if(console.log(`[Material Status Change Response] ID: ${d}`,JSON.stringify(m.data)),m.data.success&&m.data.material){console.log(`[SUCCESS] Redrawing row for ${d} with status from server: ${m.data.material.status}`),j(e,m.data.material,!0,s);const f=document.getElementById(`material-status-checkbox-${d}`);f?console.log(`Checkbox ${d} state after redraw: ${f.checked} (Server status: ${m.data.material.status})`):console.warn(`Checkbox ${d} not found after redraw.`),m.data.costs_updated&&(console.log(`Refreshing costs for char ${e}`),C(s.id,e))}else console.error(`[ERROR/UNEXPECTED] ID: ${d}, ServerSuccess: ${m.data.success}, MaterialData: ${!!m.data.material}`),x(m,m.data.message||"ステータス更新に失敗しました(レスポンス形式不正)。",`material-form-errors-${e}`),i&&(i.checked=p),alert(m.data.message||"ステータス更新に失敗しました。表示を元に戻します。")}).catch(m=>{console.error(`[CATCH ERROR] ID: ${d}`,m.response||m),x(m.response,"ステータス更新中に通信エラーが発生しました。",`material-form-errors-${e}`),i&&(i.checked=p),alert("ステータス更新中にエラーが発生しました。表示を元に戻します。")})}})}function A(n){const e=document.getElementById(`costs-content-${n}`);if(!e)return;const a=e.querySelector("table tbody");if(!a)return;let s=0;a.querySelectorAll('tr[id^="cost-row-"]').forEach(r=>{const u=r.querySelector(".cost-amount");u&&(s+=parseFloat(String(u.textContent).replace(/[^0-9.-]+/g,""))||0)});const t=e.querySelector(".p-3.rounded-md span.font-semibold");if(t){t.textContent=Number(s).toLocaleString()+"円";const r=t.closest(".p-3.rounded-md");r&&(s>0?(r.classList.remove("bg-gray-100","text-gray-700","dark:bg-gray-700/30","dark:text-gray-300"),r.classList.add("bg-green-100","text-green-700","dark:bg-green-700/30","dark:text-green-200")):(r.classList.remove("bg-green-100","text-green-700","dark:bg-green-700/30","dark:text-green-200"),r.classList.add("bg-gray-100","text-gray-700","dark:bg-gray-700/30","dark:text-gray-300")))}}function L(n,e){const a=document.getElementById(`cost-form-${n}`);if(!a)return;a.reset(),a.setAttribute("action",e);const s=document.getElementById(`cost-form-method-${n}`);s&&(s.value="POST");const t=document.getElementById(`cost-form-id-${n}`);t&&(t.value="");const r=document.getElementById(`cost-form-title-${n}`);r&&(r.textContent="コストを追加");const u=document.getElementById(`cost-form-submit-btn-text-${n}`);u&&(u.textContent="追加");const i=document.getElementById(`cost-form-submit-btn-${n}`);i&&(i.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),i.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"));const l=document.getElementById(`cost-form-cancel-btn-${n}`);l&&(l.style.display="none");const d=document.getElementById(`cost-form-errors-${n}`);d&&(d.innerHTML=""),a.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(c=>{c.classList.remove("border-red-500","dark:border-red-600")});const o=a.querySelector(`#cost_cost_date_input-${n}`)||a.querySelector('[id^="cost_cost_date_input"]');if(o&&!(t&&t.value)){const c=new Date,p=c.getFullYear(),m=String(c.getMonth()+1).padStart(2,"0"),f=String(c.getDate()).padStart(2,"0");o.value=`${p}-${m}-${f}`}}function W(n,e,a,s){const t=document.querySelector(`#costs-content-${n} table tbody`);if(!t)return;const r=document.getElementById(`cost-row-${e.id}`),u=e.notes?B(b(e.notes)):"-",i=Number(e.amount).toLocaleString()+"円";let l="-";if(e.cost_date&&typeof e.cost_date=="string"){const f=new Date(e.cost_date);isNaN(f.getTime())?l="日付エラー":l=f.toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",timeZone:"Asia/Tokyo"})}else l="日付なし";const d=E();let o="",c="bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-100";e.type==="材料費"?c="bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100":e.type==="作業費"&&(c="bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100"),o=`<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${c}">${b(e.type)}</span>`;let p='<div class="flex items-center justify-end space-x-1">';p+=`
        <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-cost-btn"
                title="編集"
                data-id="${e.id}"
                data-cost_date="${e.cost_date?e.cost_date.substring(0,10):""}"
                data-type="${b(e.type||"")}"
                data-amount="${e.amount||""}"
                data-item_description="${b(e.item_description||"")}"
                data-notes="${b(e.notes||"")}">
            <i class="fas fa-edit fa-sm"></i>
        </button>`,p+=`
        <form action="/projects/${s.id}/characters/${n}/costs/${e.id}"
              method="POST" class="delete-cost-form"
              data-id="${e.id}"
              onsubmit="return false;">
            <input type="hidden" name="_token" value="${d}">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit"
                class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                title="削除">
                <i class="fas fa-trash fa-sm"></i>
            </button>
        </form>`,p+="</div>";const m=`
        <td class="px-2 py-1.5 whitespace-nowrap text-center text-gray-400 drag-handle">
            <i class="fas fa-grip-vertical"></i>
        </td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 cost-cost_date">${b(l)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap cost-type">${o}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 cost-amount">${i}</td>
        <td class="px-4 py-1.5 whitespace-normal break-words text-gray-700 dark:text-gray-200 cost-item_description">${b(e.item_description)}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 whitespace-pre-wrap break-words text-left leading-tight cost-notes" style="min-width: 150px;">
            ${u}
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">
            ${p}
        </td>
    `;if(a&&r)r.innerHTML=m;else if(!a){const f=document.createElement("tr");f.id=`cost-row-${e.id}`,f.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),f.innerHTML=m;const v=t.querySelector('td[colspan="6"]');v&&v.parentElement.remove(),t.appendChild(f)}A(n)}function z(n,e,a,s){const t=document.getElementById(`cost-form-${e}`);if(!t)return;const r=t.dataset.storeUrl,u=document.getElementById(`cost-form-title-${e}`),i=document.getElementById(`cost-form-submit-btn-${e}`),l=document.getElementById(`cost-form-submit-btn-text-${e}`),d=document.getElementById(`cost-form-cancel-btn-${e}`),o=document.getElementById(`cost-form-method-${e}`),c=document.getElementById(`cost-form-id-${e}`),p=`cost-form-errors-${e}`;n.addEventListener("click",function(m){const f=m.target.closest(".edit-cost-btn");if(f){m.preventDefault(),u&&(u.textContent="コストを編集"),t.setAttribute("action",`/projects/${s.id}/characters/${e}/costs/${f.dataset.id}`),o&&(o.value="PUT"),c&&(c.value=f.dataset.id),t.querySelector(`[id="cost_cost_date_input-${e}"]`).value=f.dataset.cost_date,t.querySelector(`[id="cost_type_input-${e}"]`).value=f.dataset.type,t.querySelector(`[id="cost_amount_input-${e}"]`).value=f.dataset.amount,t.querySelector(`[id="cost_item_description_input-${e}"]`).value=f.dataset.item_description,t.querySelector(`[id="cost_notes_input-${e}"]`).value=f.dataset.notes||"",l&&(l.textContent="更新"),i&&(i.classList.remove("bg-green-500","hover:bg-green-600"),i.classList.add("bg-yellow-500","hover:bg-yellow-600")),d&&(d.style.display="inline-flex");const g=document.getElementById(p);g&&(g.innerHTML=""),t.querySelector(`[id="cost_cost_date_input-${e}"]`).focus()}const v=m.target.closest(".delete-cost-form");v&&(m.preventDefault(),confirm("このコストを本当に削除しますか？")&&$.delete(v.action,{headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(g=>{if(g.data.success){const h=`cost-row-${v.dataset.id}`,y=document.getElementById(h);y&&y.remove(),L(e,r),A(e),g.data.material_status_updated}else x(g,"削除に失敗しました。",p)}).catch(g=>{x(g.response,"削除中にエラーが発生しました。",p)}))}),d&&d.addEventListener("click",function(){L(e,r)}),t.addEventListener("submit",function(m){m.preventDefault();const f=document.getElementById(p);f&&(f.innerHTML="");const v=new FormData(t),g=t.getAttribute("action");let h="post";o&&o.value==="PUT"&&v.append("_method","PUT"),$({method:h,url:g,data:v,headers:{"X-CSRF-TOKEN":a,Accept:"application/json"}}).then(y=>{if(y.data.success&&y.data.cost){const _=o&&o.value==="PUT";W(e,y.data.cost,_,s),L(e,t.dataset.storeUrl),y.data.material_status_updated}else x(y,"コスト処理に失敗しました。",p)}).catch(y=>{x(y.response,"コスト送信中にエラーが発生しました。",p)})})}function J(n){n.querySelectorAll('form[id^="task-form-"]').forEach(a=>{a.addEventListener("submit",s=>{s.preventDefault();const t=a.querySelector('input[name="character_id"]'),r=t?t.value:"",u=`task-form-errors-${r||"project"}`,i=document.getElementById(u);i&&(i.innerHTML="");const d=`/projects/${document.getElementById("project-show-main-container").dataset.projectId}/tasks`,o=new FormData(a);$.post(d,o,{headers:{"X-CSRF-TOKEN":E(),Accept:"application/json"}}).then(c=>{if(c.data.success){const p=r?`character-tasks-table-${r}`:"project-tasks-table",m=document.querySelector(`#${p} tbody`);if(m){const f=m.querySelector("td[colspan]");f&&f.parentElement.remove(),m.insertAdjacentHTML("beforeend",c.data.html)}a.reset()}}).catch(c=>{var p,m;x(c.response,"登録に失敗しました。",u,(m=(p=c.response)==null?void 0:p.data)==null?void 0:m.errors)})})})}function V(){const n=document.getElementById("batch-task-form");if(!n)return;const e=n.closest("[x-data]");n.addEventListener("submit",a=>{a.preventDefault();const s=document.getElementById("batch-task-form-errors");s&&(s.innerHTML="");const r=`/projects/${document.getElementById("project-show-main-container").dataset.projectId}/tasks/batch`,u=new FormData(n);$.post(r,u,{headers:{"X-CSRF-TOKEN":E(),Accept:"application/json"}}).then(i=>{if(i.data.success){const l=i.data.tasks||[],d={};i.data.html&&l.forEach(o=>{const c=new RegExp(`<tr id="task-row-${o.id}"[\\s\\S]*?<\\/tr>`),p=i.data.html.match(c);p&&(d[o.id]=p[0])}),l.forEach(o=>{const c=o.character_id?`character-tasks-table-${o.character_id}`:"project-tasks-table",p=document.querySelector(`#${c} tbody`);if(p&&d[o.id]){const m=p.querySelector("td[colspan]");m&&m.parentElement.remove(),p.insertAdjacentHTML("beforeend",d[o.id])}}),e&&e.dispatchEvent(new CustomEvent("close-modal",{detail:"batch-task-modal",bubbles:!0})),alert(i.data.message)}}).catch(i=>{var l,d;x(i.response,"一括登録に失敗しました。","batch-task-form-errors",(d=(l=i.response)==null?void 0:l.data)==null?void 0:d.errors)})})}function Q(){const n=document.getElementById("project-show-main-container");if(!n){console.error("[project-show-main.js] CRITICAL: mainContainer not found. Exiting initialization.");return}const e=n.dataset.projectId,a=E();let s={id:e};if(n.dataset.project)try{s=JSON.parse(n.dataset.project)}catch(r){console.error("[project-show-main.js] Failed to parse project data from HTML attribute:",r)}J(n),V(),n.addEventListener("change",function(r){const u=r.target.closest(".project-flag-select, .project-status-select");u&&u.closest(".lg\\:col-span-1")&&D(u,a)}),n.querySelectorAll(".js-character-card").forEach(r=>{const u=r.querySelector('[id^="measurements-content-"]'),i=r.querySelector('[id^="materials-content-"]'),l=r.querySelector('[id^="costs-content-"]');let d=null;u?d=u.id.split("-").pop():i?d=i.id.split("-").pop():l&&(d=l.id.split("-").pop()),d?(u&&K(u,d,a,s),i&&X(i,d,a,s),l&&z(l,d,a,s)):console.warn("[project-show-main.js] Could not determine characterId for a character card. Skipping interactions init.",r)})}document.getElementById("project-show-main-container")&&Q();
