import{$ as h}from"./dropzone-DnLKvtV7.js";import{a as p}from"./app-BPaYLRGH.js";typeof h<"u"&&h.autoDiscover!==void 0&&(h.autoDiscover=!1);const i=document.getElementById("upload-loading-overlay");document.addEventListener("alpine:init",()=>{Alpine.store("ganttDropzone",{instance:null,currentProjectId:null,currentTaskId:null,init(l,d){this.currentProjectId=l,this.currentTaskId=d;const e=document.getElementById("gantt-file-upload-dropzone-alpine");if(!e){console.warn("Dropzone element #gantt-file-upload-dropzone-alpine not found!");return}const o=document.querySelector('meta[name="csrf-token"]');if(!o||!o.getAttribute("content")){console.error("CSRF token not found for Gantt Dropzone.");return}const s=`/projects/${this.currentProjectId}/tasks/${this.currentTaskId}/files`;this.instance&&this.instance.destroy();const a=e.querySelector(".dz-button-bootstrap");this.instance=new h(e,{url:s,method:"post",clickable:a||!0,paramName:"file",maxFilesize:100,addRemoveLinks:!0,dictRemoveFile:"×",headers:{"X-CSRF-TOKEN":o.getAttribute("content")},autoProcessQueue:!1,init:function(){this.on("success",(n,t)=>{Alpine.store("ganttDropzone").fetchFiles(),this.removeFile(n)}),this.on("error",(n,t)=>{let r="アップロードに失敗しました。";typeof t=="string"?r=t:t&&t.errors&&t.errors.file?r=t.errors.file[0]:t&&t.message&&(r=t.message),typeof t=="object"&&t!==null&&t.message&&(r=t.message),alert("エラー: "+r),this.removeFile(n),i&&(i.style.display="none")}),this.on("queuecomplete",()=>{i&&(i.style.display="none"),this.getQueuedFiles().length===0&&this.getUploadingFiles().length===0&&(this.getRejectedFiles().length>0||this.getFilesWithStatus(h.ERROR).length>0)}),this.on("processingmultiple",()=>{i&&(i.style.display="flex")}),this.on("sendingmultiple",()=>{i&&(i.style.display="flex")})}})},fetchFiles(l,d){const e=l||this.currentProjectId,o=d||this.currentTaskId;if(!e||!o){console.warn("Project ID or Task ID not available for fetching files.");return}const s=document.getElementById("gantt-uploaded-file-list-alpine");if(!s){console.warn("File list element #gantt-uploaded-file-list-alpine not found!");return}s.innerHTML='<li class="p-3 text-center text-sm text-gray-500 dark:text-gray-400">ファイルを読み込み中...</li>',p.get(`/projects/${e}/tasks/${o}/files`).then(a=>{s.innerHTML=a.data}).catch(a=>{s.innerHTML='<li class="p-3 text-center text-sm text-red-600 dark:text-red-400">ファイル一覧の取得に失敗しました。</li>',console.error("Error fetching files for Gantt modal:",a)})},processQueue(){i&&(i.style.display="flex"),this.instance&&this.instance.getQueuedFiles().length>0?this.instance.processQueue():(i&&(i.style.display="none"),alert("アップロードするファイルが選択されていません。"))},removeAllFiles(){this.instance&&this.instance.removeAllFiles(!0);const l=document.getElementById("gantt-uploaded-file-list-alpine");l&&(l.innerHTML='<li class="p-3 text-center text-sm text-gray-500 dark:text-gray-400">ファイルがありません。</li>')}})});typeof $<"u"?$(document).ready(function(){if($("#ganttTable").length===0)return;$(document).on("click",".toggle-children",function(){const e=$(this),o=e.find("i"),s=o.hasClass("fa-chevron-down"),a=e.closest("tr");let n;if(a.hasClass("project-header")){const t=e.data("project-id");n=$(`tr.project-${t}-tasks.task-level-0:not(.project-header)`)}else if(a.hasClass("character-header")){const t=e.data("character-id"),r=e.data("project-id-of-char");n=$(`tr.project-${r}-tasks.task-parent-char-${t}.task-level-1`)}else{const t=e.data("task-id");t&&(n=$(`tr.task-parent-${t}`))}if(!n||n.length===0){s?o.removeClass("fa-chevron-down").addClass("fa-chevron-right"):o.removeClass("fa-chevron-right").addClass("fa-chevron-down");return}if(s){let t=function(r){r.each(function(){const c=$(this);c.hide();const f=c.find(".toggle-children").first();if(f.length>0){f.find("i").removeClass("fa-chevron-down").addClass("fa-chevron-right");let u;const g=f.data("character-id"),m=f.data("task-id");if(g){const y=f.data("project-id-of-char");u=$(`tr.project-${y}-tasks.task-parent-char-${g}.task-level-1`)}else m&&(u=$(`tr.task-parent-${m}`));u&&u.length>0&&t(u)}})};o.removeClass("fa-chevron-down").addClass("fa-chevron-right"),t(n)}else o.removeClass("fa-chevron-right").addClass("fa-chevron-down"),n.show()});function d(){const e=$(".gantt-cell.today").first();if(e.length){const o=$(".gantt-container");if(o.length===0)return;const s=$(".gantt-sticky-col").first().outerWidth(!0)||0,n=e.position().left-s-20;o.animate({scrollLeft:o.scrollLeft()+n},300)}}$("#todayBtn").on("click",d),$(document).on("change",".status-select",function(){const e=$(this).data("task-id"),o=$(this).data("project-id"),s=$(this).val();let a=0;s==="completed"?a=100:(s==="not_started"||s==="cancelled")&&(a=0),p.post(`/projects/${o}/tasks/${e}/progress`,{status:s,progress:a},{headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}).then(n=>{n.data.success||console.error("ステータス更新に失敗しました: "+(n.data.message||"")),location.reload()}).catch(n=>{console.error("ステータス更新中にエラーが発生しました。",n)})}),$(document).on("click",'.editable-cell[data-field="assignee"]',function(){const e=$(this);if(e.find("input").length)return;const o=e.find("span").text().trim()==="-"?"":e.find("span").text().trim(),s=e.data("task-id"),a=e.data("project-id");e.find("span").hide();const n=$(`<input type="text" class="form-input text-sm p-1 border border-blue-500 rounded dark:bg-gray-700 dark:text-gray-200 w-full" value="${o}">`);e.append(n),n.focus().select();function t(){const r=n.val().trim();n.remove(),e.find("span").text(r||"-").show(),r!==o&&p.post(`/projects/${a}/tasks/${s}/assignee`,{assignee:r},{headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}).then(c=>{c.data.success?e.data("current-value",r):(console.error("担当者の更新に失敗しました: "+(c.data.message||"")),e.find("span").text(o||"-"))}).catch(c=>{console.error("担当者更新中にエラーが発生しました。",c),e.find("span").text(o||"-")})}n.on("blur",t),n.on("keydown",function(r){r.key==="Enter"?(r.preventDefault(),t()):r.key==="Escape"&&(n.val(o),t())})}),$(document).on("click","#gantt-uploaded-file-list-alpine .delete-file-btn",function(e){e.preventDefault();const o=$(this),s=o.data("url");if(!s){console.error("Delete URL not found on Gantt delete button");return}confirm("本当にこのファイルを削除しますか？")&&p.delete(s,{headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}).then(function(a){if(a.data.success){const n=o.closest("li");n&&n.remove();const t=document.getElementById("gantt-uploaded-file-list-alpine");t&&t.children.length===0&&(t.innerHTML='<li class="p-3 text-center text-sm text-gray-500 dark:text-gray-400">アップロードされたファイルはありません。</li>')}else alert(`ファイルの削除に失敗しました。
`+(a.data.message||""))}).catch(function(a){alert("ファイルの削除中にエラーが発生しました。"),console.error(a)})}),window.addEventListener("close-modal",e=>{e.detail.name==="ganttFileUploadModal"&&Alpine.store("ganttDropzone")&&Alpine.store("ganttDropzone").instance&&Alpine.store("ganttDropzone").removeAllFiles()})}):console.log("jQuery is not loaded. Some Gantt chart interactions might not work. Ensure jQuery is globally available before this script runs, typically via bootstrap.js.");
