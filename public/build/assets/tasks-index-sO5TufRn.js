import{T as q,a as y}from"./app-ClBWmr-F.js";function x(t){switch(t){case"completed":return'<i class="fas fa-check-circle text-green-500" title="完了"></i>';case"in_progress":return'<i class="fas fa-play-circle text-blue-500" title="進行中"></i>';case"on_hold":return'<i class="fas fa-pause-circle text-yellow-500" title="一時停止中"></i>';case"cancelled":return'<i class="fas fa-times-circle text-red-500" title="キャンセル"></i>';case"not_started":default:return'<i class="far fa-circle text-gray-400" title="未着手"></i>'}}function I(t,e,r){if(!t)return;const s=t.querySelector(".task-status-icon-wrapper");if(s){let o=!1;if(t.tagName.toLowerCase()==="tr"){const i=t.querySelector("td:nth-child(2), td:nth-child(1)");i&&(o=!!(i.querySelector("i.fa-flag")||i.querySelector("i.fa-folder")))}else t.tagName.toLowerCase()==="li"&&(o=!!(s.querySelector("i.fa-flag")||s.querySelector("i.fa-folder")));o||(s.innerHTML=x(e))}t.dataset.progress=r,t.dataset.taskStatus=e;const a=t.querySelector(".task-status-select");a&&(a.value=e),N(t.dataset.taskId,e,r)}function N(t,e,r){document.querySelectorAll(`.timer-controls[data-task-id="${t}"], .timer-display-only[data-task-id="${t}"]`).forEach(a=>{if(a.dataset.taskStatus=e,window.initializeWorkTimers){const o=new CustomEvent("timer-ui-update",{detail:{taskId:t,newStatus:e,newProgress:r}});window.dispatchEvent(o)}})}async function w(t,e,r,s,a){var l,c,n,m;const o=a.closest("tr, li");if(!o)return;const i=o.dataset.taskStatus;if(r==="in_progress"&&i!=="in_progress"&&!confirm(`タスクを「進行中」にしますか？
この操作は作業タイマーを開始します。`)){h(a);return}try{const d=await y.post(`/projects/${e}/tasks/${t}/progress`,{status:r,progress:s});d.data.success&&S(a,r,s,d.data)}catch(d){if((c=(l=d.response)==null?void 0:l.data)!=null&&c.requires_confirmation)if(await _(d.response.data.warnings))try{const f=await y.post(`/projects/${e}/tasks/${t}/progress`,{status:r,progress:s,force_update:!0});f.data.success&&S(a,r,s,f.data)}catch(f){console.error("Force update failed:",f),alert("ステータスの更新に失敗しました。"),h(a)}else h(a);else{console.error("Status update failed:",d);const u=((m=(n=d.response)==null?void 0:n.data)==null?void 0:m.message)||"ステータスの更新に失敗しました。";alert(u),h(a)}}}function S(t,e,r,s){const a=t.closest("tr, li");if(a&&I(a,e,r),s.work_log_message&&L(s.work_log_message),s.running_logs){const o=document.getElementById("running-work-logs-data");o&&(o.textContent=JSON.stringify(s.running_logs)),window.dispatchEvent(new CustomEvent("work-log-status-changed",{detail:{hasActiveWorkLog:s.running_logs.length>0}}))}}function h(t){const e=t.closest("tr, li");if(!e)return;const r=e.dataset.taskStatus||"not_started";if(t.tagName.toLowerCase()==="select")t.value=r;else if(t.type==="checkbox"){const s=e.querySelector(".task-status-in-progress"),a=e.querySelector(".task-status-completed");s&&(s.checked=r==="in_progress"),a&&(a.checked=r==="completed")}}async function _(t){for(const e of t)if(!confirm(e.message+`

このまま続行しますか？`))return!1;return!0}function T(){document.querySelectorAll(".task-status-checkbox").forEach(t=>{t.addEventListener("change",function(){const e=this.closest("tr, li");if(!e)return;const r=e.dataset.taskId,s=e.dataset.projectId,a=this.dataset.action;if(!r||!s)return;const o=e.querySelector(".task-status-in-progress"),i=e.querySelector(".task-status-completed");let l="not_started",c=0;const n=Number.parseInt(e.dataset.progress||"0")||0;this.checked&&(a==="set-in-progress"&&i&&(i.checked=!1),a==="set-completed"&&o&&(o.checked=!1)),o!=null&&o.checked?(l="in_progress",c=n>0&&n<100?n:10):i!=null&&i.checked&&(l="completed",c=100),w(r,s,l,c,this)})})}function b(){document.querySelectorAll(".task-status-select").forEach(t=>{t.addEventListener("change",function(){const e=this.closest("tr, li");if(!e||e.dataset.taskStatus===this.value)return;const r=e.dataset.taskId,s=e.dataset.projectId,a=this.value;let o=0;const i=Number.parseInt(e.dataset.progress||"0")||0;a==="completed"?o=100:a==="in_progress"&&(o=i>0&&i<100?i:10),w(r,s,a,o,this)})})}function L(t){const e=document.createElement("div");e.className="fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-md shadow-lg z-50 transition-opacity duration-300",e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)},3e3)}function C(){document.querySelectorAll('[id^="assignee-data-container"]').forEach(t=>{let e=[];try{e=JSON.parse(t.dataset.assigneeOptions)}catch(r){console.error("担当者選択肢のJSON解析に失敗しました。",r,t);return}t.addEventListener("click",r=>{const s=r.target.closest(".editable-cell-assignees");if(!s||s.querySelector(".ts-control"))return;const a=s.closest("tr");if(!a)return;const o=a.dataset.taskId,i=a.dataset.projectId,l=JSON.parse(s.dataset.currentAssignees||"[]"),c=s.querySelector(".assignee-badge-container");c&&(c.style.display="none");const n=document.createElement("select");n.setAttribute("multiple","multiple"),s.appendChild(n);const m=new q(n,{options:e,items:l,valueField:"id",labelField:"name",searchField:"name",plugins:["remove_button"],create:!1,placeholder:"担当者を選択...",onBlur:function(){setTimeout(()=>{d(this,s,c)},150)}}),d=(u,f,p)=>{if(!u.wrapper||!u.wrapper.parentNode)return;const k=u.items,v=[...l].sort(),E=[...k].sort();if(JSON.stringify(v)===JSON.stringify(E)){p&&(p.style.display="flex"),u.destroy(),n.remove();return}y.post(`/projects/${i}/tasks/${o}/assignee`,{assignees:k}).then(g=>{g.data.success?(p&&(p.innerHTML=g.data.assigneesHtml),f.dataset.currentAssignees=JSON.stringify(k)):alert(g.data.message||"更新に失敗しました。")}).catch(g=>{console.error("担当者の更新中にエラーが発生しました:",g),alert("担当者の更新中にエラーが発生しました。")}).finally(()=>{p&&(p.style.display="flex"),u.destroy(),n.parentNode&&n.remove()})};m.focus()})})}function A(){document.querySelectorAll(".toggle-folder-files").forEach(t=>{t.addEventListener("click",function(){const e=document.getElementById(this.dataset.target),r=this.querySelector("i");!e||!r||(e.classList.toggle("hidden"),r.classList.toggle("fa-chevron-down"),r.classList.toggle("fa-chevron-up"))})})}function O(){try{b(),T(),C(),A()}catch(t){console.error("Error during tasks-index.js specific initialization:",t)}}window.initTasksIndex=O;export{O as default};
