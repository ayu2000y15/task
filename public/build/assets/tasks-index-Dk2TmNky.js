import{a as h}from"./app-ysMB-Dan.js";function q(t){switch(t){case"completed":return'<i class="fas fa-check-circle text-green-500" title="完了"></i>';case"in_progress":return'<i class="fas fa-play-circle text-blue-500" title="進行中"></i>';case"on_hold":return'<i class="fas fa-pause-circle text-yellow-500" title="保留中"></i>';case"cancelled":return'<i class="fas fa-times-circle text-red-500" title="キャンセル"></i>';case"not_started":default:return'<i class="far fa-circle text-gray-400" title="未着手"></i>'}}function y(t,s,c){if(!t)return;const i=t.querySelector(".task-status-icon-wrapper");if(i){let o=!1;if(t.tagName.toLowerCase()==="tr"){const r=t.querySelector("td:nth-child(2)");r&&(o=!!(r.querySelector("i.fa-flag")||r.querySelector("i.fa-folder")))}else t.tagName.toLowerCase()==="li"&&(o=!!(i.querySelector("i.fa-flag")||i.querySelector("i.fa-folder")));o||(i.innerHTML=q(s))}t.dataset.progress=c;const e=t.querySelector(".task-status-select");e&&(e.value=s,e.dataset.originalStatus=s,e.dataset.currentProgress=c)}function E(){document.querySelectorAll(".task-status-checkbox").forEach(t=>{t.addEventListener("change",function(){const s=this.closest("tr, li");if(!s)return;const c=s.dataset.taskId,i=s.dataset.projectId,e=this.dataset.action;if(!c||!i)return;const o=s.querySelector(".task-status-in-progress"),r=s.querySelector(".task-status-completed");let d="not_started",n=0,l=parseInt(s.dataset.progress||"0")||0;this.checked&&(e==="set-in-progress"&&r&&(r.checked=!1),e==="set-completed"&&o&&(o.checked=!1)),o!=null&&o.checked?(d="in_progress",n=l>0&&l<100?l:10):r!=null&&r.checked&&(d="completed",n=100),h.post(`/projects/${i}/tasks/${c}/progress`,{status:d,progress:n}).then(a=>{a.data.success&&y(s,d,n)})})})}function v(){document.querySelectorAll(".task-status-select").forEach(t=>{t.addEventListener("change",function(){var r;const s=this.dataset.taskId,c=this.dataset.projectId,i=this.value;let e=0,o=parseInt(((r=this.closest("tr, li"))==null?void 0:r.dataset.progress)||"0")||0;i==="completed"?e=100:i==="in_progress"&&(e=o>0&&o<100?o:10),h.post(`/projects/${c}/tasks/${s}/progress`,{status:i,progress:e}).then(d=>{if(d.data.success){const n=this.closest("tr, li");y(n,i,e);const l=n==null?void 0:n.querySelector(".task-status-in-progress"),a=n==null?void 0:n.querySelector(".task-status-completed");l&&(l.checked=i==="in_progress"),a&&(a.checked=i==="completed")}})})})}function x(){const t=document.querySelectorAll('[id^="assignee-data-container"]');if(t.length===0){console.warn("担当者選択肢のデータコンテナが見つかりません。");return}t.forEach(s=>{let c=[];try{c=JSON.parse(s.dataset.assigneeOptions)}catch(e){console.error("担当者選択肢のJSON解析に失敗しました。",e,s);return}s.querySelectorAll(".editable-cell-assignees").forEach(e=>{e.addEventListener("click",function(o){if(e.querySelector(".ts-control"))return;const r=e.closest("tr");if(!r)return;const d=r.dataset.taskId,n=r.dataset.projectId,l=JSON.parse(e.dataset.currentAssignees||"[]"),a=e.querySelector(".assignee-badge-container");a&&(a.style.display="none");const u=document.createElement("select");u.setAttribute("multiple","multiple"),e.appendChild(u);const m=new TomSelect(u,{options:c,items:l,valueField:"id",labelField:"name",searchField:"name",plugins:["remove_button"],create:!1,placeholder:"担当者を選択...",onBlur:function(){setTimeout(()=>{k(this)},150)}}),k=f=>{if(!f.wrapper)return;const g=f.items,S=[...l].sort(),I=[...g].sort();if(JSON.stringify(S)===JSON.stringify(I)){a&&(a.style.display="flex"),f.destroy(),u.remove();return}h.post(`/projects/${n}/tasks/${d}/assignee`,{assignees:g}).then(p=>{p.data.success?(a&&(a.innerHTML=p.data.assigneesHtml,a.style.display="flex"),e.dataset.currentAssignees=JSON.stringify(g)):(a&&(a.style.display="flex"),alert(p.data.message||"更新に失敗しました。"))}).catch(p=>{console.error("担当者の更新中にエラーが発生しました:",p),alert("担当者の更新中にエラーが発生しました。"),a&&(a.style.display="flex")}).finally(()=>{f.wrapper&&f.destroy(),u.parentNode&&u.remove()})};m.focus()})})})}function b(){document.querySelectorAll(".toggle-folder-files").forEach(t=>{t.addEventListener("click",function(){const s=document.getElementById(this.dataset.target),c=this.querySelector("i");!s||!c||(s.classList.toggle("hidden"),c.classList.toggle("fa-chevron-down"),c.classList.toggle("fa-chevron-up"))})})}try{v(),E(),x(),b()}catch(t){console.error("Error during tasks-index.js specific initialization:",t)}
