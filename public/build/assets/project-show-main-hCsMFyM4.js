import{a as h}from"./app-BKGCNJKk.js";const j={0:{tooltip:"未納品",icon:"fa-truck",colorClass:"text-yellow-500 dark:text-yellow-400"},1:{tooltip:"納品済み",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"}},P={Pending:{tooltip:"未払い",icon:"fa-clock",colorClass:"text-yellow-500 dark:text-yellow-400"},Processing:{tooltip:"支払い中",icon:"fa-hourglass-half",colorClass:"text-blue-500 dark:text-blue-400"},Completed:{tooltip:"支払完了",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"},"Partially Paid":{tooltip:"一部支払い",icon:"fa-adjust",colorClass:"text-orange-500 dark:text-orange-400"},Overdue:{tooltip:"期限切れ",icon:"fa-exclamation-triangle",colorClass:"text-red-500 dark:text-red-400"},Cancelled:{tooltip:"キャンセル",icon:"fa-ban",colorClass:"text-gray-500 dark:text-gray-400"},Refunded:{tooltip:"返金済み",icon:"fa-undo",colorClass:"text-purple-500 dark:text-purple-400"},"On Hold":{tooltip:"保留中",icon:"fa-pause-circle",colorClass:"text-indigo-500 dark:text-indigo-400"},"":{tooltip:"未設定",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"}},I={not_started:{tooltip:"未着手",icon:"fa-minus-circle",colorClass:"text-gray-500 dark:text-gray-400"},in_progress:{tooltip:"進行中",icon:"fa-play-circle",colorClass:"text-blue-500 dark:text-blue-400"},completed:{tooltip:"完了",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"},on_hold:{tooltip:"保留中",icon:"fa-pause-circle",colorClass:"text-yellow-500 dark:text-yellow-400"},cancelled:{tooltip:"キャンセル",icon:"fa-times-circle",colorClass:"text-red-500 dark:text-red-400"},"":{tooltip:"未設定",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"}};function F(n,e,i){if(n){const l=Object.keys(i).includes("")?"":Object.keys(i)[0],t=i[e]||i[l]||{tooltip:e||"-",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"};n.title=t.tooltip;const a=n.querySelector("i");if(a){const d=Array.from(a.classList).filter(r=>r.startsWith("fa-")||r.startsWith("text-")||r.startsWith("dark:text-"));a.classList.remove(...d);const o=t.icon.split(" ");a.classList.add("fas",...o),t.colorClass&&t.colorClass.split(" ").forEach(r=>a.classList.add(r))}else n.innerHTML=`<i class="fas ${t.icon} ${t.colorClass||""}"></i>`}}function M(n,e){n.dataset.projectId;const i=n.name,l=n.value,t=n.dataset.url,a=n.dataset.iconTarget,d=document.getElementById(a);h.patch(t,{[i]:l},{headers:{"X-CSRF-TOKEN":e,Accept:"application/json","Content-Type":"application/json"}}).then(o=>{if(o.data.success){if(d){let r;i==="delivery_flag"?r=j:i==="payment_flag"?r=P:i==="status"&&(r=I),r&&F(d,l,r)}if(o.data.updated_project_status!==void 0){const r=n.dataset.statusTargetSelect,s=n.dataset.statusTargetIcon;if(r){const u=document.getElementById(r);u&&(u.value=o.data.updated_project_status)}if(s){const u=document.getElementById(s);u&&F(u,o.data.updated_project_status,I)}}}else alert("更新に失敗しました: "+(o.data.message||"サーバーエラー"))}).catch(o=>{let r="更新中にエラーが発生しました。";o.response&&o.response.data&&o.response.data.message?r+=`
`+o.response.data.message:o.response&&o.response.status&&(r+=` (ステータス: ${o.response.status})`),alert(r)})}function x(n,e="処理に失敗しました。",i=null){let l=e,t=null;if(n&&n.data){if(n.data.message&&(typeof n.data.message!="object"||Object.keys(n.data.message).length>0)&&(l=n.data.message),n.data.errors){t=n.data.errors;let d=[];for(const o in t)d.push(t[o].join("; "));d.length>0&&l===e&&(l=d.join(`
`))}}else n&&typeof n=="string"&&(l=n);const a=i?document.getElementById(i):null;if(a&&t){let d='<ul class="list-disc pl-5 text-red-600 dark:text-red-400">';for(const r in t)t[r].forEach(s=>{d+=`<li>${y(s)}</li>`});d+="</ul>",a.innerHTML=d;const o=a.closest("form");o&&Object.keys(t).forEach(r=>{const s=r.includes(".")?r.split(".").map((m,p)=>p===0?m:`[${m}]`).join(""):r,u=o.querySelector(`[name="${s}"], [name="${s}[]"]`);u&&u.classList.add("border-red-500","dark:border-red-600")})}else a&&l?a.innerHTML=`<p class="text-red-600 dark:text-red-400">${B(y(String(l)))}</p>`:l&&!a&&alert(String(l))}function E(){const n=document.querySelector('meta[name="csrf-token"]');return n?n.getAttribute("content"):null}function y(n){return n===null||typeof n>"u"?"":String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function B(n){return typeof n>"u"||n===null?"":String(n).replace(/(\r\n|\n\r|\r|\n)/g,"<br>$1")}function C(n,e){const i=document.getElementById(`costs-content-${e}`);if(!i){console.warn(`Could not find costs tab container for character: ${e}`);return}const l=`/projects/${n}/characters/${e}/costs-partial`;h.get(l).then(t=>{i.innerHTML=t.data}).catch(t=>{console.error("Error refreshing costs list:",t),i.innerHTML='<p class="text-red-500 p-4">コスト情報の更新に失敗しました。</p>'})}function H(n,e){const i=document.getElementById(`measurement-form-${n}`);if(!i){console.warn(`Measurement form not found for reset: measurement-form-${n}`);return}i.reset(),i.setAttribute("action",e);const l=document.getElementById(`measurement-form-method-${n}`);l&&(l.value="POST");const t=document.getElementById(`measurement-form-id-${n}`);t&&(t.value="");const a=document.getElementById(`measurement-form-title-${n}`);a&&(a.textContent="採寸データを追加");const d=document.getElementById(`measurement-form-submit-btn-text-${n}`);d&&(d.textContent="追加");const o=document.getElementById(`measurement-form-submit-btn-${n}`);o&&(o.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),o.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"));const r=document.getElementById(`measurement-form-cancel-btn-${n}`);r&&(r.style.display="none");const s=document.getElementById(`measurement-form-errors-${n}`);s&&(s.innerHTML=""),i.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(u=>{u.classList.remove("border-red-500","dark:border-red-600")})}function O(n,e,i,l){const t=document.querySelector(`#measurements-content-${n} table tbody`);if(!t){console.warn(`Measurement table body not found for character ${n}`);return}const a=document.getElementById(`measurement-row-${e.id}`),d=e.notes?B(y(e.notes)):"-",o=E();let r='<div class="flex items-center justify-end space-x-1">';r+=`
        <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-measurement-btn"
                title="編集"
                data-id="${e.id}"
                data-item="${y(e.item||"")}"
                data-value="${y(e.value||"")}"
                data-notes="${y(e.notes||"")}">
            <i class="fas fa-edit fa-sm"></i>
        </button>`,r+=`
        <form action="/projects/${l.id}/characters/${n}/measurements/${e.id}"
              method="POST" class="delete-measurement-form"
              data-id="${e.id}"
              onsubmit="return false;">
            <input type="hidden" name="_token" value="${o}">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit"
                class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                title="削除">
                <i class="fas fa-trash fa-sm"></i>
            </button>
        </form>`,r+="</div>";const s=`
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 measurement-item">${y(e.item)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 measurement-value">${y(e.value)}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 whitespace-pre-wrap break-words text-left leading-tight measurement-notes" style="min-width: 150px;">
            ${d}
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">
            ${r}
        </td>
    `;if(i&&a)a.innerHTML=s;else if(!i){const u=document.createElement("tr");u.id=`measurement-row-${e.id}`,u.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),u.innerHTML=s;const m=t.querySelector('td[colspan="4"]');m&&m.parentElement.remove(),t.appendChild(u)}}function D(n,e,i,l){const t=document.getElementById(`measurement-form-${e}`);if(!t){console.warn(`Measurement form not found for character ${e}`);return}const a=t.dataset.storeUrl,d=document.getElementById(`measurement-form-title-${e}`),o=document.getElementById(`measurement-form-submit-btn-${e}`),r=document.getElementById(`measurement-form-submit-btn-text-${e}`),s=document.getElementById(`measurement-form-cancel-btn-${e}`),u=document.getElementById(`measurement-form-method-${e}`),m=document.getElementById(`measurement-form-id-${e}`),p=`measurement-form-errors-${e}`;n.addEventListener("click",function(v){const c=v.target.closest(".edit-measurement-btn");if(c){v.preventDefault(),d&&(d.textContent="採寸データを編集"),t.setAttribute("action",`/projects/${l.id}/characters/${e}/measurements/${c.dataset.id}`),u&&(u.value="PUT"),m&&(m.value=c.dataset.id);const g=t.querySelector(`[id="measurement_item_input-${e}"]`),$=t.querySelector(`[id="measurement_value_input-${e}"]`),f=t.querySelector(`[id="measurement_notes_input-${e}"]`);g&&(g.value=c.dataset.item),$&&($.value=c.dataset.value),f&&(f.value=c.dataset.notes||""),r&&(r.textContent="更新"),o&&(o.classList.remove("bg-green-500","hover:bg-green-600"),o.classList.add("bg-yellow-500","hover:bg-yellow-600")),s&&(s.style.display="inline-flex");const k=document.getElementById(p);k&&(k.innerHTML=""),g&&g.focus()}const b=v.target.closest(".delete-measurement-form");b&&(v.preventDefault(),confirm("この採寸データを本当に削除しますか？")&&h.delete(b.action,{headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then(g=>{if(g.data.success){const $=`measurement-row-${b.dataset.id}`,f=document.getElementById($);f&&f.remove(),H(e,a)}else x(g,"削除に失敗しました。",p)}).catch(g=>{x(g.response,"削除中にエラーが発生しました。",p)}))}),s&&s.addEventListener("click",function(){H(e,a)}),t.addEventListener("submit",function(v){v.preventDefault();const c=document.getElementById(p);c&&(c.innerHTML="");const b=new FormData(t),g=t.getAttribute("action");let $="post";document.getElementById(`measurement-form-method-${e}`).value==="PUT"&&b.append("_method","PUT"),h({method:$,url:g,data:b,headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then(f=>{if(f.data.success&&f.data.measurement){const k=document.getElementById(`measurement-form-method-${e}`).value==="PUT";O(e,f.data.measurement,k,l),H(e,a)}else x(f,"処理に失敗しました。",p)}).catch(f=>{x(f.response,"送信中にエラーが発生しました。",p)})})}function L(n){const e=document.getElementById(`material-form-${n}`);return e?{form:e,inventorySelect:document.getElementById(`inventory_item_id_input-${n}`),manualNameField:document.getElementById(`manual_material_name_field-${n}`),manualNameInput:document.getElementById(`manual_material_name_input-${n}`),unitDisplay:document.getElementById(`material_unit_display-${n}`),quantityInput:document.getElementById(`material_quantity_input-${n}`),priceDisplay:document.getElementById(`material_price_display-${n}`),notesInput:document.getElementById(`material_notes_input-${n}`),statusCheckbox:document.getElementById(`material_status_checkbox_for_form-${n}`),methodField:document.getElementById(`material-form-method-${n}`),idField:document.getElementById(`material-form-id-${n}`),nameHiddenInput:document.getElementById(`material_name_hidden_input-${n}`),unitHiddenInput:document.getElementById(`material_unit_hidden_input-${n}`),priceHiddenInput:document.getElementById(`material_price_hidden_input-${n}`),unitPriceHiddenInput:document.getElementById(`material_unit_price_hidden_input-${n}`),statusHiddenInput:document.getElementById(`material_status_hidden_input-${n}`),formTitle:document.getElementById(`material-form-title-${n}`),submitBtn:document.getElementById(`material-form-submit-btn-${n}`),submitBtnText:document.getElementById(`material-form-submit-btn-text-${n}`),cancelBtn:document.getElementById(`material-form-cancel-btn-${n}`),errorDiv:document.getElementById(`material-form-errors-${n}`),storeUrl:e.dataset.storeUrl}:null}function _(n){const e=L(n);if(!e)return;const i=e.inventorySelect.options[e.inventorySelect.selectedIndex],l=parseFloat(e.quantityInput.value);if(i.value&&i.value!=="manual_input"){const t=parseFloat(i.dataset.avg_price);if(!isNaN(t)&&!isNaN(l)&&l>0){const a=t*l;e.priceDisplay.value=Math.round(a).toLocaleString()+"円",e.priceHiddenInput.value=Math.round(a),e.unitPriceHiddenInput.value=t}else e.priceDisplay.value="",e.priceHiddenInput.value="",e.unitPriceHiddenInput.value=""}else if(i.value==="manual_input"){const t=e.priceDisplay.value.replace(/[円,]/g,""),a=parseFloat(t);isNaN(a)?(e.priceHiddenInput.value="",e.unitPriceHiddenInput.value=""):(e.priceHiddenInput.value=a,!isNaN(l)&&l>0?e.unitPriceHiddenInput.value=a/l:e.unitPriceHiddenInput.value="")}else e.priceDisplay.value="",e.priceHiddenInput.value="",e.unitPriceHiddenInput.value=""}function T(n){const e=L(n);if(!e)return;const i=e.inventorySelect.value,l=e.inventorySelect.options[e.inventorySelect.selectedIndex];i==="manual_input"?(e.manualNameField.classList.remove("hidden"),e.manualNameInput.required=!0,e.unitDisplay.readOnly=!1,e.unitDisplay.placeholder="単位を入力 (例: 個, m)",e.unitDisplay.classList.remove("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.priceDisplay.readOnly=!1,e.priceDisplay.placeholder="合計価格を入力 (例: 1000)",e.priceDisplay.classList.remove("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.statusCheckbox.checked=!1,e.statusCheckbox.disabled=!1,e.statusHiddenInput.value="未購入"):i?(e.manualNameField.classList.add("hidden"),e.manualNameInput.required=!1,e.manualNameInput.value="",e.unitDisplay.readOnly=!0,e.unitDisplay.placeholder="品目選択で自動表示",e.unitDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.unitDisplay.value=l.dataset.unit||"",e.priceDisplay.readOnly=!0,e.priceDisplay.placeholder="自動計算",e.priceDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.statusCheckbox.checked=!0,e.statusCheckbox.disabled=!0,e.statusHiddenInput.value="購入済",e.nameHiddenInput.value=l.dataset.name||"",e.unitHiddenInput.value=l.dataset.unit||""):(e.manualNameField.classList.add("hidden"),e.manualNameInput.required=!1,e.manualNameInput.value="",e.unitDisplay.readOnly=!0,e.unitDisplay.placeholder="品目選択で自動表示",e.unitDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.unitDisplay.value="",e.priceDisplay.readOnly=!0,e.priceDisplay.placeholder="自動計算",e.priceDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400"),e.priceDisplay.value="",e.statusCheckbox.checked=!1,e.statusCheckbox.disabled=!1,e.statusHiddenInput.value="未購入",e.nameHiddenInput.value="",e.unitHiddenInput.value=""),_(n)}function w(n,e){const i=L(n);if(!i)return;const l=e||i.storeUrl;i.form.reset(),i.form.setAttribute("action",l),i.methodField&&(i.methodField.value="POST"),i.idField&&(i.idField.value=""),i.formTitle&&(i.formTitle.textContent="材料を追加"),i.submitBtnText&&(i.submitBtnText.textContent="追加"),i.submitBtn&&(i.submitBtn.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),i.submitBtn.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300")),i.cancelBtn&&(i.cancelBtn.style.display="none"),i.errorDiv&&(i.errorDiv.innerHTML=""),i.form.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(t=>{t.classList.remove("border-red-500","dark:border-red-600")}),i.inventorySelect&&(i.inventorySelect.value=""),i.manualNameField&&i.manualNameField.classList.add("hidden"),i.manualNameInput&&(i.manualNameInput.value="",i.manualNameInput.required=!1),i.unitDisplay&&(i.unitDisplay.value="",i.unitDisplay.readOnly=!0,i.unitDisplay.placeholder="品目選択で自動表示",i.unitDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400")),i.priceDisplay&&(i.priceDisplay.value="",i.priceDisplay.readOnly=!0,i.priceDisplay.placeholder="自動計算",i.priceDisplay.classList.add("bg-gray-100","dark:bg-gray-800","dark:text-gray-400")),i.statusCheckbox&&(i.statusCheckbox.checked=!1,i.statusCheckbox.disabled=!1),i.statusHiddenInput&&(i.statusHiddenInput.value="未購入"),i.nameHiddenInput&&(i.nameHiddenInput.value=""),i.unitHiddenInput&&(i.unitHiddenInput.value=""),i.priceHiddenInput&&(i.priceHiddenInput.value=""),i.unitPriceHiddenInput&&(i.unitPriceHiddenInput.value=""),T(n)}function q(n,e,i,l){console.log(l);const t=document.querySelector(`#materials-content-${n} table tbody`);if(!t)return;const a=document.getElementById(`material-row-${e.id}`),d=e.notes?B(y(e.notes)):"-",o=e.price!==null?Number(e.price).toLocaleString()+"円":"-",r=E(),s=`/projects/${l.id}/characters/${n}/materials/${e.id}`;let u='<div class="flex items-center justify-end space-x-1">';u+=`
            <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-material-btn"
                    title="編集"
                    data-id="${e.id}"
                    data-inventory_item_id="${e.inventory_item_id||""}"
                    data-name="${y(e.name||"")}"
                    data-price="${e.price||""}"
                    data-unit="${y(e.unit||"")}"
                    data-unit_price_at_creation="${e.unit_price_at_creation||""}"
                    data-quantity_needed="${y(e.quantity_needed||"")}"
                    data-status="${y(e.status||"未購入")}"
                    data-notes="${y(e.notes||"")}">
                <i class="fas fa-edit fa-sm"></i>
            </button>`,u+=`
            <form action="/projects/${l.id}/characters/${n}/materials/${e.id}"
                  method="POST" class="delete-material-form"
                  data-id="${e.id}"
                  onsubmit="return false;">
                <input type="hidden" name="_token" value="${r}">
                <input type="hidden" name="_method" value="DELETE">
                <button type="submit"
                    class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                    title="削除">
                    <i class="fas fa-trash fa-sm"></i>
                </button>
            </form>`,u+="</div>";let m;e.inventory_item_id?m='<span class="text-xs px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">購入済</span>':m=`
                <input type="checkbox"
                    id="material-status-checkbox-${e.id}"
                    class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 dark:bg-gray-900 dark:border-gray-600 material-status-checkbox"
                    data-url="${s}"
                    data-id="${e.id}" data-character-id="${n}"
                    ${e.status==="購入済"?"checked":""}>`;const p=e.inventory_item?e.inventory_item.name:e.name,v=e.unit||(e.inventory_item?e.inventory_item.unit:"");let c;const b=parseFloat(e.quantity_needed);(v||"").toLowerCase()==="m"?c=b.toFixed(b%1!==0?1:0):b%1===0?c=b.toFixed(0):c=b.toString();const $=`
        <td class="px-3 py-1.5 whitespace-nowrap">
            ${m}
        </td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-name">
            ${y(p)} ${e.inventory_item_id?'<span class="text-xs text-gray-400">(在庫品)</span>':""}
        </td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-unit">${y(v)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-quantity_needed">${y(c)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-price">${o}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 break-words text-left leading-tight material-notes" style="min-width: 150px;">
            ${d}
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">
            ${u}
        </td>
    `;if(i&&a)a.innerHTML=$;else if(!i){const f=document.createElement("tr");f.id=`material-row-${e.id}`,f.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),f.innerHTML=$;const k=t.querySelector('td[colspan="7"]');k&&k.parentElement.remove(),t.appendChild(f)}}function U(n,e,i,l){const t=L(e);if(!t||!t.form)return;const a=t.storeUrl;t.inventorySelect&&t.inventorySelect.addEventListener("change",function(){T(e)}),t.quantityInput&&t.quantityInput.addEventListener("input",function(){_(e)}),t.priceDisplay&&(t.priceDisplay.addEventListener("input",function(){this.readOnly||_(e)}),t.priceDisplay.addEventListener("blur",function(){if(!this.readOnly){let d=this.value.replace(/[円,]/g,"");!isNaN(parseFloat(d))&&isFinite(d)?this.value=parseFloat(d).toLocaleString()+"円":d.trim()!==""?this.value="":this.value="",_(e)}})),t.unitDisplay&&t.unitDisplay.addEventListener("input",function(){!this.readOnly&&t.unitHiddenInput&&(t.unitHiddenInput.value=this.value)}),t.manualNameInput&&t.manualNameInput.addEventListener("input",function(){t.nameHiddenInput&&(t.nameHiddenInput.value=this.value)}),t.statusCheckbox&&t.statusCheckbox.addEventListener("change",function(){t.statusHiddenInput&&(t.statusHiddenInput.value=this.checked?"購入済":"未購入")}),T(e),n.addEventListener("click",function(d){const o=d.target.closest(".edit-material-btn");if(o){d.preventDefault(),w(e,a),t.formTitle&&(t.formTitle.textContent="材料を編集"),t.form.setAttribute("action",`/projects/${l.id}/characters/${e}/materials/${o.dataset.id}`),t.methodField&&(t.methodField.value="PUT"),t.idField&&(t.idField.value=o.dataset.id);const s=o.dataset.inventory_item_id,u=o.dataset.status;s?t.inventorySelect.value=s:t.inventorySelect.value="manual_input";const m=new Event("change");t.inventorySelect.dispatchEvent(m),setTimeout(()=>{if(s||(t.manualNameInput&&(t.manualNameInput.value=o.dataset.name||""),t.unitDisplay&&(t.unitDisplay.value=o.dataset.unit||"")),t.quantityInput&&(t.quantityInput.value=o.dataset.quantity_needed),t.notesInput&&(t.notesInput.value=o.dataset.notes||""),t.priceDisplay){const p=o.dataset.price;t.priceDisplay.value=p&&!isNaN(parseFloat(p))?Number(p).toLocaleString()+"円":""}if(t.priceHiddenInput&&(t.priceHiddenInput.value=o.dataset.price||""),t.unitPriceHiddenInput&&(t.unitPriceHiddenInput.value=o.dataset.unit_price_at_creation||""),t.statusCheckbox&&t.statusHiddenInput){const p=u==="購入済";t.statusCheckbox.checked=p,t.statusHiddenInput.value=u}_(e)},0),t.submitBtnText&&(t.submitBtnText.textContent="更新"),t.submitBtn&&(t.submitBtn.classList.remove("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"),t.submitBtn.classList.add("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300")),t.cancelBtn&&(t.cancelBtn.style.display="inline-flex"),t.errorDiv&&(t.errorDiv.innerHTML=""),s?t.quantityInput&&t.quantityInput.focus():t.manualNameInput&&t.manualNameInput.focus()}const r=d.target.closest(".delete-material-form");r&&(d.preventDefault(),confirm("この材料を本当に削除しますか？")&&h.delete(r.action,{headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then(s=>{if(s.data.success){const u=`material-row-${r.dataset.id}`,m=document.getElementById(u);m&&m.remove(),w(e,a),s.data.costs_updated&&C(l.id,e)}else x(s,"削除に失敗しました。",`material-form-errors-${e}`)}).catch(s=>{x(s.response,"削除中にエラーが発生しました。",`material-form-errors-${e}`)}))}),t.cancelBtn&&t.cancelBtn.addEventListener("click",function(){w(e,a)}),t.form.addEventListener("submit",function(d){if(d.preventDefault(),t.errorDiv&&(t.errorDiv.innerHTML=""),t.inventorySelect.value==="manual_input")t.nameHiddenInput&&t.manualNameInput&&(t.nameHiddenInput.value=t.manualNameInput.value),t.unitHiddenInput&&t.unitDisplay&&(t.unitHiddenInput.value=t.unitDisplay.value);else{const s=t.inventorySelect.options[t.inventorySelect.selectedIndex];s&&s.value?(t.nameHiddenInput&&(t.nameHiddenInput.value=s.dataset.name||""),t.unitHiddenInput&&(t.unitHiddenInput.value=s.dataset.unit||"")):(t.nameHiddenInput&&(t.nameHiddenInput.value=""),t.unitHiddenInput&&(t.unitHiddenInput.value=""))}const o=new FormData(t.form),r=t.form.getAttribute("action");h({method:"post",url:r,data:o,headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then(s=>{if(s.data.success&&s.data.material){const u=t.methodField&&t.methodField.value==="PUT";q(e,s.data.material,u,l),w(e,a),s.data.costs_updated&&C(l.id,e)}else x(s,s.data.message||"処理に失敗しました。",`material-form-errors-${e}`,s.data.errors)}).catch(s=>{var u,m;x(s.response,"送信中にエラーが発生しました。",`material-form-errors-${e}`,(m=(u=s.response)==null?void 0:u.data)==null?void 0:m.errors)})}),n.addEventListener("change",function(d){const o=d.target.closest(".material-status-checkbox");if(o&&o.dataset.characterId===e){o.dataset.id;const r=o.checked?"購入済":"未購入",s=o.dataset.url;h.put(s,{status:r},{headers:{"X-CSRF-TOKEN":i,Accept:"application/json","Content-Type":"application/json"}}).then(u=>{u.data.success&&u.data.material?(q(e,u.data.material,!0,l),u.data.costs_updated&&C(l.id,e)):(x(u,"ステータス更新に失敗しました。",`material-form-errors-${e}`),o.checked=!o.checked)}).catch(u=>{x(u.response,"ステータス更新中にエラーが発生しました。",`material-form-errors-${e}`),o.checked=!o.checked})}})}function N(n){const e=document.getElementById(`costs-content-${n}`);if(!e)return;const i=e.querySelector("table tbody");if(!i)return;let l=0;i.querySelectorAll('tr[id^="cost-row-"]').forEach(a=>{const d=a.querySelector(".cost-amount");d&&(l+=parseFloat(String(d.textContent).replace(/[^0-9.-]+/g,""))||0)});const t=e.querySelector(".p-3.rounded-md span.font-semibold");if(t){t.textContent=Number(l).toLocaleString()+"円";const a=t.closest(".p-3.rounded-md");a&&(l>0?(a.classList.remove("bg-gray-100","text-gray-700","dark:bg-gray-700/30","dark:text-gray-300"),a.classList.add("bg-green-100","text-green-700","dark:bg-green-700/30","dark:text-green-200")):(a.classList.remove("bg-green-100","text-green-700","dark:bg-green-700/30","dark:text-green-200"),a.classList.add("bg-gray-100","text-gray-700","dark:bg-gray-700/30","dark:text-gray-300")))}}function S(n,e){const i=document.getElementById(`cost-form-${n}`);if(!i)return;i.reset(),i.setAttribute("action",e);const l=document.getElementById(`cost-form-method-${n}`);l&&(l.value="POST");const t=document.getElementById(`cost-form-id-${n}`);t&&(t.value="");const a=document.getElementById(`cost-form-title-${n}`);a&&(a.textContent="コストを追加");const d=document.getElementById(`cost-form-submit-btn-text-${n}`);d&&(d.textContent="追加");const o=document.getElementById(`cost-form-submit-btn-${n}`);o&&(o.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),o.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"));const r=document.getElementById(`cost-form-cancel-btn-${n}`);r&&(r.style.display="none");const s=document.getElementById(`cost-form-errors-${n}`);s&&(s.innerHTML=""),i.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(m=>{m.classList.remove("border-red-500","dark:border-red-600")});const u=i.querySelector(`#cost_cost_date_input-${n}`)||i.querySelector('[id^="cost_cost_date_input"]');if(u&&!(t&&t.value)){const m=new Date,p=m.getFullYear(),v=String(m.getMonth()+1).padStart(2,"0"),c=String(m.getDate()).padStart(2,"0");u.value=`${p}-${v}-${c}`}}function A(n,e,i,l){const t=document.querySelector(`#costs-content-${n} table tbody`);if(!t)return;const a=document.getElementById(`cost-row-${e.id}`),d=e.notes?B(y(e.notes)):"-",o=Number(e.amount).toLocaleString()+"円";let r="-";if(e.cost_date&&typeof e.cost_date=="string"){const c=new Date(e.cost_date);isNaN(c.getTime())?r="日付エラー":r=c.toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",timeZone:"Asia/Tokyo"})}else r="日付なし";const s=E();let u="",m="bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-100";e.type==="材料費"?m="bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100":e.type==="作業費"&&(m="bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100"),u=`<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${m}">${y(e.type)}</span>`;let p='<div class="flex items-center justify-end space-x-1">';p+=`
        <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-cost-btn"
                title="編集"
                data-id="${e.id}"
                data-cost_date="${e.cost_date?e.cost_date.substring(0,10):""}"
                data-type="${y(e.type||"")}"
                data-amount="${e.amount||""}"
                data-item_description="${y(e.item_description||"")}"
                data-notes="${y(e.notes||"")}">
            <i class="fas fa-edit fa-sm"></i>
        </button>`,p+=`
        <form action="/projects/${l.id}/characters/${n}/costs/${e.id}"
              method="POST" class="delete-cost-form"
              data-id="${e.id}"
              onsubmit="return false;">
            <input type="hidden" name="_token" value="${s}">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit"
                class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                title="削除">
                <i class="fas fa-trash fa-sm"></i>
            </button>
        </form>`,p+="</div>";const v=`
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 cost-cost_date">${y(r)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap cost-type">${u}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 cost-amount">${o}</td>
        <td class="px-4 py-1.5 whitespace-normal break-words text-gray-700 dark:text-gray-200 cost-item_description">${y(e.item_description)}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 whitespace-pre-wrap break-words text-left leading-tight cost-notes" style="min-width: 150px;">
            ${d}
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">
            ${p}
        </td>
    `;if(i&&a)a.innerHTML=v;else if(!i){const c=document.createElement("tr");c.id=`cost-row-${e.id}`,c.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),c.innerHTML=v;const b=t.querySelector('td[colspan="6"]');b&&b.parentElement.remove(),t.appendChild(c)}N(n)}function R(n,e,i,l){const t=document.getElementById(`cost-form-${e}`);if(!t)return;const a=t.dataset.storeUrl,d=document.getElementById(`cost-form-title-${e}`),o=document.getElementById(`cost-form-submit-btn-${e}`),r=document.getElementById(`cost-form-submit-btn-text-${e}`),s=document.getElementById(`cost-form-cancel-btn-${e}`),u=document.getElementById(`cost-form-method-${e}`),m=document.getElementById(`cost-form-id-${e}`),p=`cost-form-errors-${e}`;n.addEventListener("click",function(v){const c=v.target.closest(".edit-cost-btn");if(c){v.preventDefault(),d&&(d.textContent="コストを編集"),t.setAttribute("action",`/projects/${l.id}/characters/${e}/costs/${c.dataset.id}`),u&&(u.value="PUT"),m&&(m.value=c.dataset.id),t.querySelector(`[id="cost_cost_date_input-${e}"]`).value=c.dataset.cost_date,t.querySelector(`[id="cost_type_input-${e}"]`).value=c.dataset.type,t.querySelector(`[id="cost_amount_input-${e}"]`).value=c.dataset.amount,t.querySelector(`[id="cost_item_description_input-${e}"]`).value=c.dataset.item_description,t.querySelector(`[id="cost_notes_input-${e}"]`).value=c.dataset.notes||"",r&&(r.textContent="更新"),o&&(o.classList.remove("bg-green-500","hover:bg-green-600"),o.classList.add("bg-yellow-500","hover:bg-yellow-600")),s&&(s.style.display="inline-flex");const g=document.getElementById(p);g&&(g.innerHTML=""),t.querySelector(`[id="cost_cost_date_input-${e}"]`).focus()}const b=v.target.closest(".delete-cost-form");b&&(v.preventDefault(),confirm("このコストを本当に削除しますか？")&&h.delete(b.action,{headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then(g=>{if(g.data.success){const $=`cost-row-${b.dataset.id}`,f=document.getElementById($);f&&f.remove(),S(e,a),N(e),g.data.material_status_updated}else x(g,"削除に失敗しました。",p)}).catch(g=>{x(g.response,"削除中にエラーが発生しました。",p)}))}),s&&s.addEventListener("click",function(){S(e,a)}),t.addEventListener("submit",function(v){v.preventDefault();const c=document.getElementById(p);c&&(c.innerHTML="");const b=new FormData(t),g=t.getAttribute("action");let $="post";u&&u.value==="PUT"&&b.append("_method","PUT"),h({method:$,url:g,data:b,headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then(f=>{if(f.data.success&&f.data.cost){const k=u&&u.value==="PUT";A(e,f.data.cost,k,l),S(e,t.dataset.storeUrl),f.data.material_status_updated}else x(f,"コスト処理に失敗しました。",p)}).catch(f=>{x(f.response,"コスト送信中にエラーが発生しました。",p)})})}function K(){const n=document.getElementById("project-show-main-container");if(!n){console.error("[project-show-main.js] CRITICAL: mainContainer not found. Exiting initialization.");return}const e=n.dataset.projectId,i=E();let l={id:e};if(n.dataset.project)try{l=JSON.parse(n.dataset.project)}catch(a){console.error("[project-show-main.js] Failed to parse project data from HTML attribute:",a)}n.addEventListener("change",function(a){const d=a.target.closest(".project-flag-select, .project-status-select");d&&d.closest(".lg\\:col-span-1")&&M(d,i)}),n.querySelectorAll(".js-character-card").forEach(a=>{const d=a.querySelector('[id^="measurements-content-"]'),o=a.querySelector('[id^="materials-content-"]'),r=a.querySelector('[id^="costs-content-"]');let s=null;d?s=d.id.split("-").pop():o?s=o.id.split("-").pop():r&&(s=r.id.split("-").pop()),s?(d&&D(d,s,i,l),o&&U(o,s,i,l),r&&R(r,s,i,l)):console.warn("[project-show-main.js] Could not determine characterId for a character card. Skipping interactions init.",a)})}document.getElementById("project-show-main-container")&&K();
