import{a as h}from"./app-BXd1KCqm.js";const I={0:{tooltip:"未納品",icon:"fa-truck",colorClass:"text-yellow-500 dark:text-yellow-400"},1:{tooltip:"納品済み",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"}},K={Pending:{tooltip:"未払い",icon:"fa-clock",colorClass:"text-yellow-500 dark:text-yellow-400"},Processing:{tooltip:"支払い中",icon:"fa-hourglass-half",colorClass:"text-blue-500 dark:text-blue-400"},Completed:{tooltip:"支払完了",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"},"Partially Paid":{tooltip:"一部支払い",icon:"fa-adjust",colorClass:"text-orange-500 dark:text-orange-400"},Overdue:{tooltip:"期限切れ",icon:"fa-exclamation-triangle",colorClass:"text-red-500 dark:text-red-400"},Cancelled:{tooltip:"キャンセル",icon:"fa-ban",colorClass:"text-gray-500 dark:text-gray-400"},Refunded:{tooltip:"返金済み",icon:"fa-undo",colorClass:"text-purple-500 dark:text-purple-400"},"On Hold":{tooltip:"保留中",icon:"fa-pause-circle",colorClass:"text-indigo-500 dark:text-indigo-400"},"":{tooltip:"未設定",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"}},R={not_started:{tooltip:"未着手",icon:"fa-minus-circle",colorClass:"text-gray-500 dark:text-gray-400"},in_progress:{tooltip:"進行中",icon:"fa-play-circle",colorClass:"text-blue-500 dark:text-blue-400"},completed:{tooltip:"完了",icon:"fa-check-circle",colorClass:"text-green-500 dark:text-green-400"},on_hold:{tooltip:"保留中",icon:"fa-pause-circle",colorClass:"text-yellow-500 dark:text-yellow-400"},cancelled:{tooltip:"キャンセル",icon:"fa-times-circle",colorClass:"text-red-500 dark:text-red-400"},"":{tooltip:"未設定",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"}};function U(e,t,i){if(e){const l=Object.keys(i).includes("")?"":Object.keys(i)[0],n=i[t]||i[l]||{tooltip:t||"-",icon:"fa-question-circle",colorClass:"text-gray-400 dark:text-gray-500"};e.title=n.tooltip;const o=e.querySelector("i");if(o){const r=Array.from(o.classList).filter(s=>s.startsWith("fa-")||s.startsWith("text-")||s.startsWith("dark:text-"));o.classList.remove(...r);const a=n.icon.split(" ");o.classList.add("fas",...a),n.colorClass&&n.colorClass.split(" ").forEach(s=>o.classList.add(s))}else e.innerHTML=`<i class="fas ${n.icon} ${n.colorClass||""}"></i>`}}function X(e,t){e.dataset.projectId;const i=e.name,l=e.value,n=e.dataset.url,o=e.dataset.iconTarget,r=document.getElementById(o);h.patch(n,{[i]:l},{headers:{"X-CSRF-TOKEN":t,Accept:"application/json","Content-Type":"application/json"}}).then(a=>{if(a.data.success){if(r){let s;i==="delivery_flag"?s=I:i==="payment_flag"?s=K:i==="status"&&(s=R),s&&U(r,l,s)}if(a.data.updated_project_status!==void 0){const s=e.dataset.statusTargetSelect,d=e.dataset.statusTargetIcon;if(s){const c=document.getElementById(s);c&&(c.value=a.data.updated_project_status)}if(d){const c=document.getElementById(d);c&&U(c,a.data.updated_project_status,R)}}}else alert("更新に失敗しました: "+(a.data.message||"サーバーエラー"))}).catch(a=>{let s="更新中にエラーが発生しました。";a.response&&a.response.data&&a.response.data.message?s+=`
`+a.response.data.message:a.response&&a.response.status&&(s+=` (ステータス: ${a.response.status})`),alert(s)})}function w(e,t="処理に失敗しました。",i=null){let l=t,n=null;if(e&&e.data){if(e.data.message&&(typeof e.data.message!="object"||Object.keys(e.data.message).length>0)&&(l=e.data.message),e.data.errors){n=e.data.errors;let r=[];for(const a in n)r.push(n[a].join("; "));r.length>0&&l===t&&(l=r.join(`
`))}}else e&&typeof e=="string"&&(l=e);const o=i?document.getElementById(i):null;if(o&&n){let r='<ul class="list-disc pl-5 text-red-600 dark:text-red-400">';for(const s in n)n[s].forEach(d=>{r+=`<li>${v(d)}</li>`});r+="</ul>",o.innerHTML=r;const a=o.closest("form");a&&Object.keys(n).forEach(s=>{const d=s.includes(".")?s.split(".").map((g,u)=>u===0?g:`[${g}]`).join(""):s,c=a.querySelector(`[name="${d}"], [name="${d}[]"]`);c&&c.classList.add("border-red-500","dark:border-red-600")})}else o&&l?o.innerHTML=`<p class="text-red-600 dark:text-red-400">${j(v(String(l)))}</p>`:l&&!o&&alert(String(l))}function S(){const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):null}function v(e){return e===null||typeof e>"u"?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function j(e){return typeof e>"u"||e===null?"":String(e).replace(/(\r\n|\n\r|\r|\n)/g,"<br>$1")}function q(e,t){const i=document.getElementById(`costs-content-${t}`);if(!i){console.warn(`Could not find costs tab container for character: ${t}`);return}const l=`/projects/${e}/characters/${t}/costs-partial`;h.get(l).then(n=>{i.innerHTML=n.data}).catch(n=>{console.error("Error refreshing costs list:",n),i.innerHTML='<p class="text-red-500 p-4">コスト情報の更新に失敗しました。</p>'})}function F(e,t){const i=document.getElementById(`measurement-form-${e}`);if(!i){console.warn(`Measurement form not found for reset: measurement-form-${e}`);return}i.reset(),i.setAttribute("action",t);const l=document.getElementById(`measurement-form-method-${e}`);l&&(l.value="POST");const n=document.getElementById(`measurement-form-id-${e}`);n&&(n.value="");const o=document.getElementById(`measurement-form-title-${e}`);o&&(o.textContent="採寸データを追加");const r=document.getElementById(`measurement-form-submit-btn-text-${e}`);r&&(r.textContent="追加");const a=document.getElementById(`measurement-form-submit-btn-${e}`);a&&(a.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),a.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"));const s=document.getElementById(`measurement-form-cancel-btn-${e}`);s&&(s.style.display="none");const d=document.getElementById(`measurement-form-errors-${e}`);d&&(d.innerHTML=""),i.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(c=>{c.classList.remove("border-red-500","dark:border-red-600")})}function z(e,t,i,l){const n=document.querySelector(`#measurements-content-${e} table tbody`);if(!n){console.warn(`Measurement table body not found for character ${e}`);return}const o=document.getElementById(`measurement-row-${t.id}`),r=t.notes?j(v(t.notes)):"-",a=S();let s='<div class="flex items-center justify-end space-x-1">';s+=`
        <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-measurement-btn"
                title="編集"
                data-id="${t.id}"
                data-item="${v(t.item||"")}"
                data-value="${v(t.value||"")}"
                data-notes="${v(t.notes||"")}">
            <i class="fas fa-edit fa-sm"></i>
        </button>`,s+=`
        <form action="/projects/${l.id}/characters/${e}/measurements/${t.id}"
              method="POST" class="delete-measurement-form"
              data-id="${t.id}"
              onsubmit="return false;">
            <input type="hidden" name="_token" value="${a}">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit"
                class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                title="削除">
                <i class="fas fa-trash fa-sm"></i>
            </button>
        </form>`,s+="</div>";const d=`
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 measurement-item">${v(t.item)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 measurement-value">${v(t.value)}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 whitespace-pre-wrap break-words text-left leading-tight measurement-notes" style="min-width: 150px;">
            ${r}
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">
            ${s}
        </td>
    `;if(i&&o)o.innerHTML=d;else if(!i){const c=document.createElement("tr");c.id=`measurement-row-${t.id}`,c.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),c.innerHTML=d;const g=n.querySelector('td[colspan="4"]');g&&g.parentElement.remove(),n.appendChild(c)}}function W(e,t,i,l){const n=document.getElementById(`measurement-form-${t}`);if(!n){console.warn(`Measurement form not found for character ${t}`);return}const o=n.dataset.storeUrl,r=document.getElementById(`measurement-form-title-${t}`),a=document.getElementById(`measurement-form-submit-btn-${t}`),s=document.getElementById(`measurement-form-submit-btn-text-${t}`),d=document.getElementById(`measurement-form-cancel-btn-${t}`),c=document.getElementById(`measurement-form-method-${t}`),g=document.getElementById(`measurement-form-id-${t}`),u=`measurement-form-errors-${t}`;e.addEventListener("click",function(f){const m=f.target.closest(".edit-measurement-btn");if(m){f.preventDefault(),r&&(r.textContent="採寸データを編集"),n.setAttribute("action",`/projects/${l.id}/characters/${t}/measurements/${m.dataset.id}`),c&&(c.value="PUT"),g&&(g.value=m.dataset.id);const p=n.querySelector(`[id="measurement_item_input-${t}"]`),_=n.querySelector(`[id="measurement_value_input-${t}"]`),b=n.querySelector(`[id="measurement_notes_input-${t}"]`);p&&(p.value=m.dataset.item),_&&(_.value=m.dataset.value),b&&(b.value=m.dataset.notes||""),s&&(s.textContent="更新"),a&&(a.classList.remove("bg-green-500","hover:bg-green-600"),a.classList.add("bg-yellow-500","hover:bg-yellow-600")),d&&(d.style.display="inline-flex");const B=document.getElementById(u);B&&(B.innerHTML=""),p&&p.focus()}const y=f.target.closest(".delete-measurement-form");y&&(f.preventDefault(),confirm("この採寸データを本当に削除しますか？")&&h.delete(y.action,{headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then(p=>{if(p.data.success){const _=`measurement-row-${y.dataset.id}`,b=document.getElementById(_);b&&b.remove(),F(t,o)}else w(p,"削除に失敗しました。",u)}).catch(p=>{w(p.response,"削除中にエラーが発生しました。",u)}))}),d&&d.addEventListener("click",function(){F(t,o)}),n.addEventListener("submit",function(f){f.preventDefault();const m=document.getElementById(u);m&&(m.innerHTML="");const y=new FormData(n),p=n.getAttribute("action");let _="post";document.getElementById(`measurement-form-method-${t}`).value==="PUT"&&y.append("_method","PUT"),h({method:_,url:p,data:y,headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then(b=>{if(b.data.success&&b.data.measurement){const B=document.getElementById(`measurement-form-method-${t}`).value==="PUT";z(t,b.data.measurement,B,l),F(t,o)}else w(b,"処理に失敗しました。",u)}).catch(b=>{w(b.response,"送信中にエラーが発生しました。",u)})})}function H(e){const t=document.getElementById(`inventory_item_id_input-${e}`),i=document.getElementById(`material_quantity_input-${e}`),l=document.getElementById(`material_price_display-${e}`),n=document.getElementById(`material_price_hidden_input-${e}`),o=document.getElementById(`material_unit_price_hidden_input-${e}`);if(t&&i&&l&&n&&o){const r=t.options[t.selectedIndex],a=parseFloat(r.dataset.avg_price),s=parseFloat(i.value);if(r.value&&!isNaN(a)&&!isNaN(s)&&s>0){const d=a*s;l.value=Math.round(d).toLocaleString()+"円",n.value=Math.round(d),o.value=a}else l.value="",n.value="",o.value=""}}function M(e,t){const i=document.getElementById(`material-form-${e}`);if(!i)return;i.reset(),i.setAttribute("action",t);const l=document.getElementById(`material-form-method-${e}`);l&&(l.value="POST");const n=document.getElementById(`material-form-id-${e}`);n&&(n.value="");const o=document.getElementById(`material-form-title-${e}`);o&&(o.textContent="材料を追加");const r=document.getElementById(`material-form-submit-btn-text-${e}`);r&&(r.textContent="追加");const a=document.getElementById(`material-form-submit-btn-${e}`);a&&(a.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),a.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"));const s=document.getElementById(`material-form-cancel-btn-${e}`);s&&(s.style.display="none");const d=document.getElementById(`material-form-errors-${e}`);d&&(d.innerHTML=""),i.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(p=>{p.classList.remove("border-red-500","dark:border-red-600")});const c=document.getElementById(`material_unit_display-${e}`);c&&(c.value="");const g=document.getElementById(`material_price_display-${e}`);g&&(g.value="");const u=document.getElementById(`material_name_hidden_input-${e}`);u&&(u.value="");const f=document.getElementById(`material_unit_hidden_input-${e}`);f&&(f.value="");const m=document.getElementById(`material_price_hidden_input-${e}`);m&&(m.value="");const y=document.getElementById(`material_unit_price_hidden_input-${e}`);y&&(y.value="")}function O(e,t,i,l){const n=document.querySelector(`#materials-content-${e} table tbody`);if(!n)return;const o=document.getElementById(`material-row-${t.id}`),r=t.notes?j(v(t.notes)):"-",a=t.price!==null?Number(t.price).toLocaleString()+"円":"-",s=S(),d=`/projects/${l.id}/characters/${e}/materials/${t.id}`;let c='<div class="flex items-center justify-end space-x-1">';c+=`
        <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-material-btn"
                title="編集"
                data-id="${t.id}"
                data-inventory_item_id="${t.inventory_item_id||""}"
                data-name="${v(t.name||"")}"
                data-price="${t.price||""}"
                data-unit="${v(t.unit||"")}"
                data-unit_price_at_creation="${t.unit_price_at_creation||""}"
                data-quantity_needed="${v(t.quantity_needed||"")}"
                data-notes="${v(t.notes||"")}">
            <i class="fas fa-edit fa-sm"></i>
        </button>`,c+=`
        <form action="/projects/${l.id}/characters/${e}/materials/${t.id}"
              method="POST" class="delete-material-form"
              data-id="${t.id}"
              onsubmit="return false;">
            <input type="hidden" name="_token" value="${s}">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit"
                class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                title="削除">
                <i class="fas fa-trash fa-sm"></i>
            </button>
        </form>`,c+="</div>";let g=`
        <input type="checkbox"
            id="material-status-checkbox-${t.id}"
            class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 dark:bg-gray-900 dark:border-gray-600 material-status-checkbox"
            data-url="${d}"
            data-id="${t.id}" data-character-id="${e}"
            ${t.status==="購入済"?"checked":""}>`;const u=t.inventory_item?t.inventory_item.name:t.name,f=t.unit||(t.inventory_item?t.inventory_item.unit:""),m=`
        <td class="px-3 py-1.5 whitespace-nowrap">
            ${g}
        </td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-name">
            ${v(u)} ${t.inventory_item_id?'<span class="text-xs text-gray-400">(在庫品)</span>':""}
        </td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-unit">${v(f)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-quantity_needed">${v(t.quantity_needed)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 material-price">${a}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 break-words text-left leading-tight material-notes" style="min-width: 150px;">
            ${r}
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">
            ${c}
        </td>
    `;if(i&&o)o.innerHTML=m;else if(!i){const y=document.createElement("tr");y.id=`material-row-${t.id}`,y.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),y.innerHTML=m;const p=n.querySelector('td[colspan="7"]');p&&p.parentElement.remove(),n.appendChild(y)}}function J(e,t,i,l){const n=document.getElementById(`material-form-${t}`);if(!n)return;const o=n.dataset.storeUrl,r=document.getElementById(`material-form-title-${t}`),a=document.getElementById(`material-form-submit-btn-${t}`),s=document.getElementById(`material-form-submit-btn-text-${t}`),d=document.getElementById(`material-form-cancel-btn-${t}`),c=document.getElementById(`material-form-method-${t}`),g=document.getElementById(`material-form-id-${t}`),u=`material-form-errors-${t}`,f=document.getElementById(`inventory_item_id_input-${t}`),m=document.getElementById(`material_unit_display-${t}`),y=document.getElementById(`material_quantity_input-${t}`),p=document.getElementById(`material_name_hidden_input-${t}`),_=document.getElementById(`material_unit_hidden_input-${t}`),b=document.getElementById(`material_price_display-${t}`),B=document.getElementById(`material_price_hidden_input-${t}`),A=document.getElementById(`material_unit_price_hidden_input-${t}`);f&&f.addEventListener("change",function(){const E=this.options[this.selectedIndex];m&&p&&_&&(E&&E.value?(m.value=E.dataset.unit||"",p.value=E.dataset.name||"",_.value=E.dataset.unit||""):(m.value="",p.value="",_.value="")),H(t)}),y&&y.addEventListener("input",function(){H(t)}),e.addEventListener("click",function(E){var C;const x=E.target.closest(".edit-material-btn");if(x){E.preventDefault(),r&&(r.textContent="材料を編集"),n.setAttribute("action",`/projects/${l.id}/characters/${t}/materials/${x.dataset.id}`),c&&(c.value="PUT"),g&&(g.value=x.dataset.id);const $=x.dataset.inventory_item_id;if(f){f.value=$||"";const L=new Event("change");f.dispatchEvent(L)}p&&!$&&(p.value=x.dataset.name||""),_&&!$&&(_.value=x.dataset.unit||""),y&&(y.value=x.dataset.quantity_needed),n.elements.notes.value=x.dataset.notes||"",b&&(b.value=x.dataset.price?Number(x.dataset.price).toLocaleString()+"円":""),B&&(B.value=x.dataset.price||""),A&&(A.value=x.dataset.unit_price_at_creation||""),f&&f.value&&y.value&&H(t),s&&(s.textContent="更新"),a&&(a.classList.remove("bg-green-500","hover:bg-green-600"),a.classList.add("bg-yellow-500","hover:bg-yellow-600")),d&&(d.style.display="inline-flex");const k=document.getElementById(u);k&&(k.innerHTML=""),f?f.focus():(C=n.elements.name)==null||C.focus()}const T=E.target.closest(".delete-material-form");T&&(E.preventDefault(),confirm("この材料を本当に削除しますか？")&&h.delete(T.action,{headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then($=>{if($.data.success){const k=`material-row-${T.dataset.id}`,L=document.getElementById(k);L&&L.remove(),M(t,o),$.data.costs_updated&&q(l.id,t)}else w($,"削除に失敗しました。",u)}).catch($=>{w($.response,"削除中にエラーが発生しました。",u)}))}),d&&d.addEventListener("click",function(){M(t,o)}),n.addEventListener("submit",function(E){E.preventDefault();const x=document.getElementById(u);x&&(x.innerHTML="");const T=new FormData(n),C=n.getAttribute("action");let $="post";document.getElementById(`material-form-method-${t}`).value==="PUT"&&T.append("_method","PUT"),h({method:$,url:C,data:T,headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then(k=>{if(k.data.success&&k.data.material){const L=document.getElementById(`material-form-method-${t}`).value==="PUT";O(t,k.data.material,L,l),M(t,o),k.data.costs_updated&&q(l.id,t)}else w(k,"処理に失敗しました。",u)}).catch(k=>{w(k.response,"送信中にエラーが発生しました。",u)})}),e.addEventListener("change",function(E){const x=E.target.closest(".material-status-checkbox");if(x&&x.dataset.characterId===t){x.dataset.id;const T=x.checked?"購入済":"未購入",C=x.dataset.url;h.put(C,{status:T},{headers:{"X-CSRF-TOKEN":i,Accept:"application/json","Content-Type":"application/json"}}).then($=>{$.data.success&&$.data.material?(O(t,$.data.material,!0,l),$.data.costs_updated&&q(l.id,t)):(w($,"ステータス更新に失敗しました。",u),x.checked=!x.checked)}).catch($=>{w($.response,"ステータス更新中にエラーが発生しました。",u),x.checked=!x.checked})}})}function N(e){const t=document.getElementById(`costs-content-${e}`);if(!t)return;const i=t.querySelector("table tbody");if(!i)return;let l=0;i.querySelectorAll('tr[id^="cost-row-"]').forEach(o=>{const r=o.querySelector(".cost-amount");r&&(l+=parseFloat(String(r.textContent).replace(/[^0-9.-]+/g,""))||0)});const n=t.querySelector(".p-3.rounded-md span.font-semibold");if(n){n.textContent=Number(l).toLocaleString()+"円";const o=n.closest(".p-3.rounded-md");o&&(l>0?(o.classList.remove("bg-gray-100","text-gray-700","dark:bg-gray-700/30","dark:text-gray-300"),o.classList.add("bg-green-100","text-green-700","dark:bg-green-700/30","dark:text-green-200")):(o.classList.remove("bg-green-100","text-green-700","dark:bg-green-700/30","dark:text-green-200"),o.classList.add("bg-gray-100","text-gray-700","dark:bg-gray-700/30","dark:text-gray-300")))}}function P(e,t){const i=document.getElementById(`cost-form-${e}`);if(!i)return;i.reset(),i.setAttribute("action",t);const l=document.getElementById(`cost-form-method-${e}`);l&&(l.value="POST");const n=document.getElementById(`cost-form-id-${e}`);n&&(n.value="");const o=document.getElementById(`cost-form-title-${e}`);o&&(o.textContent="コストを追加");const r=document.getElementById(`cost-form-submit-btn-text-${e}`);r&&(r.textContent="追加");const a=document.getElementById(`cost-form-submit-btn-${e}`);a&&(a.classList.remove("bg-yellow-500","hover:bg-yellow-600","active:bg-yellow-700","focus:border-yellow-700","focus:ring-yellow-300"),a.classList.add("bg-green-500","hover:bg-green-600","active:bg-green-700","focus:border-green-700","focus:ring-green-300"));const s=document.getElementById(`cost-form-cancel-btn-${e}`);s&&(s.style.display="none");const d=document.getElementById(`cost-form-errors-${e}`);d&&(d.innerHTML=""),i.querySelectorAll(".form-input, .form-select, .form-textarea").forEach(g=>{g.classList.remove("border-red-500","dark:border-red-600")});const c=i.querySelector(`#cost_cost_date_input-${e}`)||i.querySelector('[id^="cost_cost_date_input"]');if(c&&!(n&&n.value)){const g=new Date,u=g.getFullYear(),f=String(g.getMonth()+1).padStart(2,"0"),m=String(g.getDate()).padStart(2,"0");c.value=`${u}-${f}-${m}`}}function V(e,t,i,l){const n=document.querySelector(`#costs-content-${e} table tbody`);if(!n)return;const o=document.getElementById(`cost-row-${t.id}`),r=t.notes?j(v(t.notes)):"-",a=Number(t.amount).toLocaleString()+"円";let s="-";if(t.cost_date&&typeof t.cost_date=="string"){const m=new Date(t.cost_date);isNaN(m.getTime())?s="日付エラー":s=m.toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",timeZone:"Asia/Tokyo"})}else s="日付なし";const d=S();let c="",g="bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-100";t.type==="材料費"?g="bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100":t.type==="作業費"&&(g="bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100"),c=`<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${g}">${v(t.type)}</span>`;let u='<div class="flex items-center justify-end space-x-1">';u+=`
        <button type="button" class="p-1 text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 edit-cost-btn"
                title="編集"
                data-id="${t.id}"
                data-cost_date="${t.cost_date?t.cost_date.substring(0,10):""}"
                data-type="${v(t.type||"")}"
                data-amount="${t.amount||""}"
                data-item_description="${v(t.item_description||"")}"
                data-notes="${v(t.notes||"")}">
            <i class="fas fa-edit fa-sm"></i>
        </button>`,u+=`
        <form action="/projects/${l.id}/characters/${e}/costs/${t.id}"
              method="POST" class="delete-cost-form"
              data-id="${t.id}"
              onsubmit="return false;">
            <input type="hidden" name="_token" value="${d}">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit"
                class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                title="削除">
                <i class="fas fa-trash fa-sm"></i>
            </button>
        </form>`,u+="</div>";const f=`
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 cost-cost_date">${v(s)}</td>
        <td class="px-4 py-1.5 whitespace-nowrap cost-type">${c}</td>
        <td class="px-4 py-1.5 whitespace-nowrap text-gray-700 dark:text-gray-200 cost-amount">${a}</td>
        <td class="px-4 py-1.5 whitespace-normal break-words text-gray-700 dark:text-gray-200 cost-item_description">${v(t.item_description)}</td>
        <td class="px-4 py-1.5 text-gray-700 dark:text-gray-200 whitespace-pre-wrap break-words text-left leading-tight cost-notes" style="min-width: 150px;">
            ${r}
        </td>
        <td class="px-3 py-1.5 whitespace-nowrap text-right">
            ${u}
        </td>
    `;if(i&&o)o.innerHTML=f;else if(!i){const m=document.createElement("tr");m.id=`cost-row-${t.id}`,m.classList.add("hover:bg-gray-50","dark:hover:bg-gray-700/50"),m.innerHTML=f;const y=n.querySelector('td[colspan="6"]');y&&y.parentElement.remove(),n.appendChild(m)}N(e)}function Y(e,t,i,l){const n=document.getElementById(`cost-form-${t}`);if(!n)return;const o=n.dataset.storeUrl,r=document.getElementById(`cost-form-title-${t}`),a=document.getElementById(`cost-form-submit-btn-${t}`),s=document.getElementById(`cost-form-submit-btn-text-${t}`),d=document.getElementById(`cost-form-cancel-btn-${t}`),c=document.getElementById(`cost-form-method-${t}`),g=document.getElementById(`cost-form-id-${t}`),u=`cost-form-errors-${t}`;e.addEventListener("click",function(f){const m=f.target.closest(".edit-cost-btn");if(m){f.preventDefault(),r&&(r.textContent="コストを編集"),n.setAttribute("action",`/projects/${l.id}/characters/${t}/costs/${m.dataset.id}`),c&&(c.value="PUT"),g&&(g.value=m.dataset.id),n.querySelector(`[id="cost_cost_date_input-${t}"]`).value=m.dataset.cost_date,n.querySelector(`[id="cost_type_input-${t}"]`).value=m.dataset.type,n.querySelector(`[id="cost_amount_input-${t}"]`).value=m.dataset.amount,n.querySelector(`[id="cost_item_description_input-${t}"]`).value=m.dataset.item_description,n.querySelector(`[id="cost_notes_input-${t}"]`).value=m.dataset.notes||"",s&&(s.textContent="更新"),a&&(a.classList.remove("bg-green-500","hover:bg-green-600"),a.classList.add("bg-yellow-500","hover:bg-yellow-600")),d&&(d.style.display="inline-flex");const p=document.getElementById(u);p&&(p.innerHTML=""),n.querySelector(`[id="cost_cost_date_input-${t}"]`).focus()}const y=f.target.closest(".delete-cost-form");y&&(f.preventDefault(),confirm("このコストを本当に削除しますか？")&&h.delete(y.action,{headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then(p=>{if(p.data.success){const _=`cost-row-${y.dataset.id}`,b=document.getElementById(_);b&&b.remove(),P(t,o),N(t),p.data.material_status_updated}else w(p,"削除に失敗しました。",u)}).catch(p=>{w(p.response,"削除中にエラーが発生しました。",u)}))}),d&&d.addEventListener("click",function(){P(t,o)}),n.addEventListener("submit",function(f){f.preventDefault();const m=document.getElementById(u);m&&(m.innerHTML="");const y=new FormData(n),p=n.getAttribute("action");let _="post";c&&c.value==="PUT"&&y.append("_method","PUT"),h({method:_,url:p,data:y,headers:{"X-CSRF-TOKEN":i,Accept:"application/json"}}).then(b=>{if(b.data.success&&b.data.cost){const B=c&&c.value==="PUT";V(t,b.data.cost,B,l),P(t,n.dataset.storeUrl),b.data.material_status_updated}else w(b,"コスト処理に失敗しました。",u)}).catch(b=>{w(b.response,"コスト送信中にエラーが発生しました。",u)})})}function Z(){const e=document.getElementById("project-show-main-container");if(!e){console.error("[project-show-main.js] CRITICAL: mainContainer not found. Exiting initialization.");return}const t=e.dataset.projectId,i=S();let l={id:t};if(e.dataset.project)try{l=JSON.parse(e.dataset.project)}catch(o){console.error("[project-show-main.js] Failed to parse project data from HTML attribute:",o)}e.addEventListener("change",function(o){const r=o.target.closest(".project-flag-select, .project-status-select");r&&r.closest(".lg\\:col-span-1")&&X(r,i)}),e.querySelectorAll(".js-character-card").forEach(o=>{const r=o.querySelector('[id^="measurements-content-"]'),a=o.querySelector('[id^="materials-content-"]'),s=o.querySelector('[id^="costs-content-"]');let d=null;r?d=r.id.split("-").pop():a?d=a.id.split("-").pop():s&&(d=s.id.split("-").pop()),d?(r&&W(r,d,i,l),a&&J(a,d,i,l),s&&Y(s,d,i,l)):console.warn("[project-show-main.js] Could not determine characterId for a character card. Skipping interactions init.",o)})}document.getElementById("project-show-main-container")&&Z();
