import{T as q,a as m}from"./app-BCPFMjEm.js";function x(e){switch(e){case"completed":return'<i class="fas fa-check-circle text-green-500" title="完了"></i>';case"in_progress":return'<i class="fas fa-play-circle text-blue-500" title="進行中"></i>';case"on_hold":return'<i class="fas fa-pause-circle text-yellow-500" title="一時停止中"></i>';case"cancelled":return'<i class="fas fa-times-circle text-red-500" title="キャンセル"></i>';case"not_started":default:return'<i class="far fa-circle text-gray-400" title="未着手"></i>'}}function I(e,t,a){if(!e)return;const r=e.querySelector(".task-status-icon-wrapper");if(r){let i=!1;if(e.tagName.toLowerCase()==="tr"){const o=e.querySelector("td:nth-child(2), td:nth-child(1)");o&&(i=!!(o.querySelector("i.fa-flag")||o.querySelector("i.fa-folder")))}else e.tagName.toLowerCase()==="li"&&(i=!!(r.querySelector("i.fa-flag")||r.querySelector("i.fa-folder")));i||(r.innerHTML=x(t))}e.dataset.progress=a;const s=e.querySelector(".task-status-select");s&&(s.value=t),N(e.dataset.taskId,t,a)}function N(e,t,a){document.querySelectorAll(`.timer-controls[data-task-id="${e}"], .timer-display-only[data-task-id="${e}"]`).forEach(s=>{if(s.dataset.taskStatus=t,window.initializeWorkTimers){const i=new CustomEvent("timer-ui-update",{detail:{taskId:e,newStatus:t,newProgress:a}});window.dispatchEvent(i)}})}async function k(e,t,a,r,s){var i,o,d,u;try{const n=await m.post(`/projects/${t}/tasks/${e}/progress`,{status:a,progress:r});n.data.success&&y(s,a,r,n.data)}catch(n){if((o=(i=n.response)==null?void 0:i.data)!=null&&o.requires_confirmation)if(await C(n.response.data.warnings))try{const l=await m.post(`/projects/${t}/tasks/${e}/progress`,{status:a,progress:r,force_update:!0});l.data.success&&y(s,a,r,l.data)}catch(l){console.error("Force update failed:",l),alert("ステータスの更新に失敗しました。"),h(s)}else h(s);else{console.error("Status update failed:",n);const c=((u=(d=n.response)==null?void 0:d.data)==null?void 0:u.message)||"ステータスの更新に失敗しました。";alert(c),h(s)}}}function y(e,t,a,r){const s=e.closest("tr, li");if(I(s,t,a),r.work_log_message&&b(r.work_log_message),r.running_logs){const i=document.getElementById("running-work-logs-data");i&&(i.textContent=JSON.stringify(r.running_logs)),window.dispatchEvent(new CustomEvent("work-log-status-changed",{detail:{hasActiveWorkLog:r.running_logs.length>0}}))}}function h(e){if(e.tagName.toLowerCase()==="select"){const a=e.closest("tr, li").dataset.taskStatus||"not_started";e.value=a}else e.type==="checkbox"&&(e.checked=!1)}async function C(e){for(const t of e)if(!confirm(t.message+`

このまま続行しますか？`))return!1;return!0}function T(){document.querySelectorAll(".task-status-checkbox").forEach(e=>{e.addEventListener("change",function(){const t=this.closest("tr, li");if(!t)return;const a=t.dataset.taskId,r=t.dataset.projectId,s=this.dataset.action;if(!a||!r)return;const i=t.querySelector(".task-status-in-progress"),o=t.querySelector(".task-status-completed");let d="not_started",u=0;const n=Number.parseInt(t.dataset.progress||"0")||0;this.checked&&(s==="set-in-progress"&&o&&(o.checked=!1),s==="set-completed"&&i&&(i.checked=!1)),i!=null&&i.checked?(d="in_progress",u=n>0&&n<100?n:10):o!=null&&o.checked&&(d="completed",u=100),k(a,r,d,u,this)})})}function _(){document.querySelectorAll(".task-status-select").forEach(e=>{e.addEventListener("change",function(){var o;const t=this.dataset.taskId,a=this.dataset.projectId,r=this.value;let s=0;const i=Number.parseInt(((o=this.closest("tr, li"))==null?void 0:o.dataset.progress)||"0")||0;r==="completed"?s=100:r==="in_progress"&&(s=i>0&&i<100?i:10),k(t,a,r,s,this)})})}function b(e){const t=document.createElement("div");t.className="fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-md shadow-lg z-50 transition-opacity duration-300",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3e3)}function L(){const e=document.querySelectorAll('[id^="assignee-data-container"]');if(e.length===0){console.warn("担当者選択肢のデータコンテナが見つかりません。");return}e.forEach(t=>{let a=[];try{a=JSON.parse(t.dataset.assigneeOptions)}catch(s){console.error("担当者選択肢のJSON解析に失敗しました。",s,t);return}t.querySelectorAll(".editable-cell-assignees").forEach(s=>{s.addEventListener("click",i=>{if(s.querySelector(".ts-control"))return;const o=s.closest("tr");if(!o)return;const d=o.dataset.taskId,u=o.dataset.projectId,n=JSON.parse(s.dataset.currentAssignees||"[]"),c=s.querySelector(".assignee-badge-container");c&&(c.style.display="none");const l=document.createElement("select");l.setAttribute("multiple","multiple"),s.appendChild(l);const S=new q(l,{options:a,items:n,valueField:"id",labelField:"name",searchField:"name",plugins:["remove_button"],create:!1,placeholder:"担当者を選択...",onBlur:function(){setTimeout(()=>{w(this)},150)}}),w=f=>{if(!f.wrapper)return;const p=f.items,v=[...n].sort(),E=[...p].sort();if(JSON.stringify(v)===JSON.stringify(E)){c&&(c.style.display="flex"),f.destroy(),l.remove();return}m.post(`/projects/${u}/tasks/${d}/assignee`,{assignees:p}).then(g=>{g.data.success?(c&&(c.innerHTML=g.data.assigneesHtml,c.style.display="flex"),s.dataset.currentAssignees=JSON.stringify(p)):(c&&(c.style.display="flex"),alert(g.data.message||"更新に失敗しました。"))}).catch(g=>{console.error("担当者の更新中にエラーが発生しました:",g),alert("担当者の更新中にエラーが発生しました。"),c&&(c.style.display="flex")}).finally(()=>{f.wrapper&&f.destroy(),l.parentNode&&l.remove()})};S.focus()})})})}function A(){document.querySelectorAll(".toggle-folder-files").forEach(e=>{e.addEventListener("click",function(){const t=document.getElementById(this.dataset.target),a=this.querySelector("i");!t||!a||(t.classList.toggle("hidden"),a.classList.toggle("fa-chevron-down"),a.classList.toggle("fa-chevron-up"))})})}function j(){try{_(),T(),L(),A()}catch(e){console.error("Error during tasks-index.js specific initialization:",e)}}export{j as default};
